<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo2.png') }}">
    <title>CVIC MENU</title>

    <style>
        @import url('static/css/color-palette.css');
        @import url('static/css/cvic.css');

        .bda-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
            gap: 10px;
        }

        .bda-card-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .bda-card-link:hover {
            transform: translateY(-2px);
            text-decoration: none;
            color: inherit;
        }

        .bda-card-link:hover .bda-card {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-color: #666;
        }

        .bda-card {
            background: #1f1f1f;
            border: 1px solid #4f545c;
            padding: 15px;
            cursor: pointer;
        }

        .bda-weapon {
            text-transform: uppercase;
            font-weight: bold;
            font-size: var(--font-size-md);
            padding-bottom: 2px;
            white-space: nowrap;
        }

        .bda-target {
            font-size: var(--font-size-sm);
            padding-bottom: 7px;
            white-space: nowrap;
        }

        .bda-id-info {
            font-size: var(--font-size-md);
            text-transform: uppercase;
            white-space: nowrap;
            display: flex;
            justify-content: space-between;
            padding-top: 3px;
        }

        .bda-result {
            font-size: var(--font-size-md);
            white-space: nowrap;
            font-weight: bolder;
        }

        .bda-img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: #121212;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-top: 5px;
            border: 1px solid #4f545c;
            text-align: center;
        }

        .bda-img.loading {
            opacity: 0.7;
        }

        .bda-img.loaded {
            opacity: 1;
        }

        .bda-footer-date {
            text-align: right;
            font-size: var(--font-size-sm);
        }

        .presentation-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            border: 1px solid #4f545c;
            background: #121212;
        }

        .presentation-container iframe {
            border: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }

        .map-container {
            position: relative;
            width: 100%;
            border: 1px solid #4f545c;
            background: #121212;
            overflow: hidden;
            max-height: 600px;
            margin-bottom: 10px;
        }

        .map-img {
            width: 100%;
            height: auto;
            display: block;
            transition: none;
            user-select: none;
            -webkit-user-drag: none;
            will-change: transform;
        }

        .map-symbols {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
        }

        .map-symbol {
            position: absolute;
            width: 36px;
            height: 36px;
            transition: none;
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.8));
            pointer-events: auto;
            cursor: pointer;
            z-index: 6;
        }

        .map-symbol:hover {
            filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.8));
            transform: translate(-50%, -50%) scale(1.2);
        }

        .map-symbol.collision {
            filter: grayscale(100%) brightness(1.0) drop-shadow(0 0 2px rgba(160, 160, 160, 0.8));
            opacity: 1;
        }

        .map-symbol.hidden {
            display: None !important;
        }
        .map-ring.hidden {
            display: None !important;
        }
        .map-symbol.collision:hover {
            filter: grayscale(100%) brightness(1.2) drop-shadow(0 0 4px rgba(180, 180, 180, 0.8));
            transform: translate(-50%, -50%) scale(1.2);
        }

        .map-symbol.collision-no-report {
            filter: grayscale(100%) brightness(0.3) drop-shadow(0 0 2px rgba(80, 80, 80, 0.8));
            opacity: 1;
        }

        .map-symbol.collision-no-report:hover {
            filter: grayscale(100%) brightness(0.5) drop-shadow(0 0 4px rgba(100, 100, 100, 0.8));
            transform: translate(-50%, -50%) scale(1.2);
        }

        .map-symbol.clickable {
            cursor: pointer;
        }

        .map-symbol.clickable:hover {
            filter: drop-shadow(0 0 6px rgba(100, 200, 255, 0.9));
            transform: translate(-50%, -50%) scale(1.3);
        }

        .map-symbol.collision.clickable:hover {
            filter: grayscale(100%) brightness(1.2) drop-shadow(0 0 6px rgba(100, 200, 255, 0.9));
            transform: translate(-50%, -50%) scale(1.3);
        }

        .map-symbol.destroyed-no-report {
            filter: brightness(0.4) saturate(0.6);
            opacity: 1;
        }

        .map-symbol.destroyed-no-report:hover {
            filter: brightness(0.6) saturate(0.8) drop-shadow(0 0 4px rgba(120, 120, 120, 0.8));
            transform: translate(-50%, -50%) scale(1.2);
        }

        .map-ring.collision {
            border-color: #ff6b6b;
        }

        .map-ring {
            position: absolute;
            border: 2px solid #ff0000;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: none;
            pointer-events: none;
            opacity: 0.7;
            z-index: 4;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }

        .fullscreen-btn {
            width: 40px;
            height: 40px;
            background: rgba(31, 31, 31, 0.9);
            border: 1px solid #4f545c;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        .fullscreen-btn:hover {
            background: rgba(79, 84, 92, 0.9);
        }

        .fullscreen-btn:active {
            background: rgba(100, 100, 100, 0.9);
        }

        .map-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            max-height: none;
            z-index: 1000;
            border: none;
        }

        .map-container.fullscreen .map-img {
            width: 100%;
            height: 100vh;
            object-fit: contain;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: rgba(31, 31, 31, 0.9);
            border: 1px solid #4f545c;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        .zoom-btn:hover {
            background: rgba(79, 84, 92, 0.9);
        }

        .zoom-btn:active {
            background: rgba(100, 100, 100, 0.9);
        }

        .zoom-level {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(31, 31, 31, 0.9);
            border: 1px solid #4f545c;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            font-family: monospace;
            z-index: 10;
        }

        .symbol-tooltip {
            position: absolute;
            background: rgba(31, 31, 31, 0.95);
            border: 1px solid #4f545c;
            color: white;
            padding: 8px 12px;
            font-size: 12px;
            pointer-events: none;
            z-index: 15;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s ease;
            min-width: 120px;
        }

        .tooltip-comment {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .tooltip-coords {
            font-size: 11px;
            color: #a0a0a0;
            line-height: 1.3;
        }

        .symbol-tooltip.show {
            opacity: 1;
        }

        .map-selector {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }

        .map-selector-btn {
            width: 100%;
            background: #1f1f1f;
            border: 1px solid #4f545c;
            color: white;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            min-width: 140px;
        }

        .map-selector-btn:hover {
            background: rgba(185, 187, 190, 0.15);
            border-color: #666;
        }

        .map-selector-btn.active {
            background: var(--color-primary);
            border-color: #718096;
            color: white;
        }

        .map-selector-btn:active {
            background: #2d3748;
        }

        .strategic-filters {
            margin-top: 20px;
            background: #1f1f1f;
            border: 1px solid #4f545c;
            padding: 20px;
        }

        .filter-title {
            color: white;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 480px) {
            .filter-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            padding: 8px 12px;
            background: #2a2a2a;
            border: 1px solid #4f545c;
            justify-content: center;
        }

        .filter-checkbox:hover {
            background: rgba(185, 187, 190, 0.15);
            border-color: #666;
        }

        .filter-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #4a5568;
        }

        .filter-checkbox input[type="checkbox"]:checked + span {
            color: #90cdf4;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: #2a2a2a;
            border: 1px solid #4f545c;
            color: white;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
        }

        .filter-btn:hover {
            background: rgba(185, 187, 190, 0.15);
            border-color: #666;
        }

        .filter-btn.primary {
            background: #4a5568;
            border-color: #718096;
        }

        .filter-btn.primary:hover {
            background: rgba(185, 187, 190, 0.15);
        }

        @media (max-width: 768px) {
            .sidebar {
                position: relative;
                width: 100%;
                max-height: none;
            }

            .main-layout {
                flex-direction: column;
            }

            .footer {
                margin-left: 0;
            }

            .container {
                margin: 0;
                border: none;
            }

            body {
                padding: 0;
            }

            .fullscreen-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }

            .map-symbol {
                width: 30px;
                height: 30px;
            }
        }

        .presentation-load-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-section);
        }

        .presentation-load-btn {
            background: var(--bg-container);
            border: 1px solid var(--border-primary);
            color: white;
            padding: 20px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
            justify-content: center;
        }

        .presentation-load-btn:hover {
            background: rgba(185, 187, 190, 0.15);
        }

        .load-text {
            font-size: 16px;
            letter-spacing: 1px;
        }

        .presentation-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #4f545c;
            border-top: 2px solid #4a5568;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .presentation-load-btn {
                padding: 15px 30px;
                font-size: 16px;
                min-width: 240px;
            }

            .load-icon {
                font-size: 20px;
            }

            .load-text {
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <img src="/static/img/logo2.png" class="header-logo" alt="CVW-17 Logo">
            <div class="title">CVIC MENU</div>
            <div class="subtitle">CARRIER AIR WING 17</div>
        </div>

        <div class="main-layout">
            <div class="sidebar">
                <a href="#" class="nav-link">HOME</a>
                <a href="/reports" class="nav-link">AP STRIKE REPORTS</a>
                <a href="/dmpi_db" class="nav-link">DMPI DATABASE</a>
                <a href="/viewer" class="nav-link">DATA VIEWER</a>
                <a href="/tacview" class="nav-link">TACVIEW</a>
                <a href="/tracks" class="nav-link">REPLAYS</a>
                <a href="https://virtualcvw17.com/" class="nav-link">CVW-17 WEBSITE</a>
            </div>

            <div class="main-content">
                <div class="content">
                    <div class="content-title">STRATEGIC AIR CAMPAIGN TARGETS</div>
                    <div class="divider"></div>

                    <div class="map-container" id="mapContainer">
                        <img class="map-img" id="mapImage" src="/static/maps/interactive_map_z1.jpg" alt="Interactive Map">

                        <div class="map-symbols" id="mapSymbols">
                            {% if drawables %}
                                {% for drawable_id, drawable_data in drawables.items() %}
                                    {% if drawable_data and drawable_data.draw %}
                                        {% for map_key, map_data in drawable_data.draw.items() %}
                                            {% if map_data and map_data.render_icon %}
                                                {% if map_data.render_ring and map_data.radius_px and map_data.radius_px > 0 and not drawable_data.collision %}
                                                    <div class="map-ring hidden"
                                                         id="ring-{{ drawable_id }}-{{ loop.index0 }}"
                                                         data-x="{{ map_data.x }}"
                                                         data-y="{{ map_data.y }}"
                                                         data-radius="{{ map_data.radius_px }}"
                                                         data-type="{{ map_data.type or '' }}"
                                                         data-map="{{ map_key }}"
                                                         style="width: {{ map_data.radius_px * 2 }}px; height: {{ map_data.radius_px * 2 }}px;">
                                                    </div>
                                                {% endif %}

                                                <img class="map-symbol hidden {% if drawable_data.collision %}collision{% endif %} {% if drawable_data.aim_points and drawable_data.aim_points["01"].debrief_id %}clickable{% endif %} {% if drawable_data.collision and drawable_data.aim_points and not drawable_data.aim_points["01"].debrief_id %}collision-no-report{% endif %}"
                                                     id="symbol-{{ drawable_id }}-{{ loop.index0 }}"
                                                     src="{{ map_data.symbol }}"
                                                     alt="{{ drawable_data.comment or drawable_id }}"
                                                     data-x="{{ map_data.x }}"
                                                     data-y="{{ map_data.y }}"
                                                     data-id="{{ drawable_id }}"
                                                     data-comment="{{ drawable_data.comment or '' }}"
                                                     data-type="{{ map_data.type or '' }}"
                                                     data-map="{{ map_key }}"
                                                     data-collision="{{ drawable_data.collision or '' }}"
                                                     data-bda="{{ drawable_data.aim_points["01"].bda}}"
                                                     data-debrief-id="{{ drawable_data.aim_points["01"].debrief_id}}"
                                                     data-lat="{{ drawable_data.aim_points and drawable_data.aim_points["01"] and drawable_data.aim_points["01"].lat or '' }}"
                                                     data-lon="{{ drawable_data.aim_points and drawable_data.aim_points["01"] and drawable_data.aim_points["01"].lon or '' }}">
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>

                        <div class="map-controls">
                            <button class="fullscreen-btn" id="downloadBtn" title="Download Image">⬇</button>
                            <button class="fullscreen-btn" id="fullscreenBtn" title="Toggle Fullscreen">⛶</button>
                            <button class="zoom-btn" id="zoomIn" title="Zoom In">+</button>
                            <button class="zoom-btn" id="zoomOut" title="Zoom Out">−</button>
                            <button class="zoom-btn" id="resetZoom" title="Reset Zoom">⌂</button>
                        </div>
                        <div class="zoom-level" id="zoomLevel">100%</div>

                        <div class="symbol-tooltip" id="symbolTooltip"></div>
                    </div>

                    <div class="map-selector">
                        <button class="map-selector-btn active" id="airDefenceBtn" data-map="z1" data-filter="SAD">AIR DEFENCES</button>
                        <button class="map-selector-btn" id="superMezBtn" data-map="z2" data-filter="SAD">SUPER MEZ</button>
                        <button class="map-selector-btn" id="strategicBtn" data-map="z1" data-filter="strategic">DMPIS</button>
                    </div>

                    <div class="strategic-filters" id="strategicFilters" style="display: none;">
                        <div class="filter-title">SELECT TARGET TYPES:</div>
                        <div class="filter-grid">
                            <label class="filter-checkbox">
                                <input type="checkbox" value="SAD">
                                <span>SAD</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="C" checked>
                                <span>C</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="L" checked>
                                <span>L</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="CCC" checked>
                                <span>CCC</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="E" checked>
                                <span>E</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="O" checked>
                                <span>O</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="RR" checked>
                                <span>RR</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="A" checked>
                                <span>A</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="N" checked>
                                <span>N</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="MS" checked>
                                <span>MS</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="SC" checked>
                                <span>SC</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="RG" checked>
                                <span>RG</span>
                            </label>
                        </div>
                    </div>

                    <div class="content-title" style="margin-top: 40px">DEPLOYMENT PRESENTATION</div>
                    <div class="divider"></div>

                    <div class="presentation-container" id="presentationContainer">
                        <div class="presentation-load-wrapper" id="presentationLoadWrapper">
                            <button class="presentation-load-btn" id="loadPresentationBtn">
                                <span class="load-text">LOAD PRESENTATION</span>
                            </button>
                        </div>

                    </div>


                    <div class="content-title" style="margin-top: 40px;">LATEST BDA</div>

                    <div class="divider"></div>

                    <div class="bda-grid">
                        {% for bda in bdas if bda['img-src'] %}
                            <a href="/debrief/{{ bda['id'] }}" class="bda-card-link">
                                <div class="bda-card">
                                    <div class="bda-weapon">{{ bda['weapon'] }}</div>
                                    <div class="bda-target">{{ bda['target'] }}</div>
                                    <div class="bda-result">{{ bda['bda-result'] }}</div>
                                    <img class="bda-img loading"
                                         alt="NO BDA IMG"
                                         src="/static/img/img-placeholder.webp"
                                         data-src="{{ bda['img-src'] }}"
                                         data-index="{{ loop.index0 }}">
                                    <div class="bda-id-info">
                                        <div>{{ bda['msn-nr'] }}</div>
                                        <div>-</div>
                                        <div>{{ bda['callsign'] }}</div>
                                        <div>-</div>
                                        <div>{{ bda['msn-evt'] }}</div>
                                    </div>
                                    <div class="bda-footer-date">{{ bda['date'] }}</div>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                </div>

            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <img src="/static/img/logo2.png" width="80" height="72" alt="CVW-17 Logo" class="footer-logo">
            <div class="footer-text">
                <div class="title">VIRTUAL CARRIER AIR WING 17</div>
                <div class="subtitle">Not associated with the Department of Defence or any of its components.</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const bdaImages = document.querySelectorAll('.bda-img[data-src]');

            function loadImage(img) {
                const actualSrc = img.getAttribute('data-src');
                if (!actualSrc || actualSrc === '/static/img/img-placeholder.webp') {
                    return;
                }
                if (img.src === actualSrc) {
                    return;
                }

                const tempImg = new Image();
                tempImg.onload = function() {
                    img.src = actualSrc;
                    img.classList.remove('loading');
                    img.classList.add('loaded');
                };
                tempImg.onerror = function() {
                    img.classList.remove('loading');
                };
                tempImg.src = actualSrc;
            }

            function unloadImage(img) {
                const actualSrc = img.getAttribute('data-src');
                if (img.src !== window.location.origin + '/static/img/img-placeholder.webp' &&
                    actualSrc && actualSrc !== '/static/img/img-placeholder.webp') {
                    img.src = '/static/img/img-placeholder.webp';
                    img.classList.add('loading');
                    img.classList.remove('loaded');
                }
            }

            const loadObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        loadImage(img);
                    }
                });
            }, {
                rootMargin: '400px 0px',
                threshold: 0.01
            });

            const unloadObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) {
                        const img = entry.target;
                        unloadImage(img);
                    }
                });
            }, {
                rootMargin: '1600px 0px',
                threshold: 0
            });

            bdaImages.forEach(img => {
                loadObserver.observe(img);
                unloadObserver.observe(img);
            });

            const mapContainer = document.getElementById('mapContainer');
            const mapImage = document.getElementById('mapImage');
            const mapSymbols = document.getElementById('mapSymbols');
            const symbolTooltip = document.getElementById('symbolTooltip');
            const zoomInBtn = document.getElementById('zoomIn');
            const zoomOutBtn = document.getElementById('zoomOut');
            const resetZoomBtn = document.getElementById('resetZoom');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const zoomLevelDisplay = document.getElementById('zoomLevel');
            const airDefenceBtn = document.getElementById('airDefenceBtn');
            const superMezBtn = document.getElementById('superMezBtn');
            const strategicBtn = document.getElementById('strategicBtn');
            const strategicFilters = document.getElementById('strategicFilters');

            let currentZoom = 1;
            let isDragging = false;
            let startX = 0;
            let startY = 0;
            let translateX = 0;
            let translateY = 0;
            let isFullscreen = false;
            let currentMapType = 'z1';
            let currentFilter = 'SAD';
            let selectedStrategicTypes = ['C', 'L', 'CCC', 'E', 'O', 'RR', 'A', 'N', 'MS', 'SC', 'RG'];

            const minZoom = 1;
            const maxZoom = 8;
            const zoomStep = 0.2;

            function switchMap(mapType, filterType) {
                const isMapChange = currentMapType !== mapType;

                currentMapType = mapType;
                currentFilter = filterType;

                currentZoom = 1;
                translateX = 0;
                translateY = 0;

                if (isMapChange) {
                    const symbols = document.querySelectorAll('.map-symbol');
                    const rings = document.querySelectorAll('.map-ring');
                    symbols.forEach(symbol => symbol.style.display = 'none');
                    rings.forEach(ring => ring.style.display = 'none');

                    mapImage.src = `/static/maps/interactive_map_${mapType}.jpg`;
                } else {
                    repositionSymbols()
                    filterAndShowSymbols();
                }
            }

            function repositionSymbols() {
                const oldZoom = currentZoom;
                const oldTranslateX = translateX;
                const oldTranslateY = translateY;

                currentZoom = 1;
                translateX = 0;
                translateY = 0;
                updateTransform();

                requestAnimationFrame(() => {
                    positionSymbols();

                    currentZoom = oldZoom;
                    translateX = oldTranslateX;
                    translateY = oldTranslateY;

                    constrainTranslation();

                    updateTransform();
                });
            }

            function filterAndShowSymbols() {
                const symbols = document.querySelectorAll('.map-symbol');
                const rings = document.querySelectorAll('.map-ring');

                symbols.forEach(symbol => {
                    const symbolMap = symbol.getAttribute('data-map');
                    const symbolType = symbol.getAttribute('data-type');

                    const mapMatches = isMapMatch(symbolMap, currentMapType);
                    let typeMatches = false;

                    if (currentFilter === 'strategic') {
                        typeMatches = selectedStrategicTypes.includes(symbolType);
                    } else {
                        typeMatches = currentFilter === '' || symbolType === currentFilter;
                    }

                    if (mapMatches && typeMatches) {
                        symbol.style.display = 'block';
                    } else {
                        symbol.style.display = 'none';
                    }
                });

                rings.forEach(ring => {
                    const ringMap = ring.getAttribute('data-map');
                    const ringType = ring.getAttribute('data-type');

                    const mapMatches = isMapMatch(ringMap, currentMapType);
                    let typeMatches = false;

                    if (currentFilter === 'strategic') {
                        typeMatches = selectedStrategicTypes.includes(ringType);
                    } else {
                        typeMatches = currentFilter === '' || ringType === currentFilter;
                    }

                    if (mapMatches && typeMatches) {
                        ring.style.display = 'block';
                    } else {
                        ring.style.display = 'none';
                    }
                });
            }

            function isMapMatch(symbolMap, targetMapType) {
                if (!symbolMap) return false;

                if (targetMapType === 'z1') {
                    return symbolMap.includes('zoom1') || symbolMap.includes('z1');
                }

                if (targetMapType === 'z2') {
                    return symbolMap.includes('zoom2') || symbolMap.includes('z2');
                }

                return false;
            }

            airDefenceBtn.addEventListener('click', function() {
                document.querySelectorAll('.map-selector-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                this.classList.add('active');

                strategicFilters.style.display = 'none';
                switchMap('z1', 'SAD');
            });

            superMezBtn.addEventListener('click', function() {
                document.querySelectorAll('.map-selector-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                this.classList.add('active');

                strategicFilters.style.display = 'none';
                switchMap('z2', 'SAD');
            });

            strategicBtn.addEventListener('click', function() {
                document.querySelectorAll('.map-selector-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                this.classList.add('active');
                strategicFilters.style.display = 'block';

                switchMap('z1', 'strategic');

                setTimeout(() => {
                    positionSymbols();
                }, 150);
            });

            function setupFilterAutoApply() {
                const checkboxes = strategicFilters.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        updateSelectedStrategicTypes();
                        filterAndShowSymbols();
                    });
                });
            }

            function updateSelectedStrategicTypes() {
                const checkboxes = strategicFilters.querySelectorAll('input[type="checkbox"]:checked');
                selectedStrategicTypes = Array.from(checkboxes).map(cb => cb.value);
            }

            setupFilterAutoApply();

            function positionSymbols() {
                const symbols = document.querySelectorAll('.map-symbol');
                const rings = document.querySelectorAll('.map-ring');

                const naturalWidth = mapImage.naturalWidth;
                const naturalHeight = mapImage.naturalHeight;

                if (!naturalWidth || !naturalHeight) return;

                let displayWidth, displayHeight, offsetX = 0, offsetY = 0;

                if (isFullscreen) {
                    const containerRect = mapContainer.getBoundingClientRect();
                    const containerWidth = containerRect.width;
                    const containerHeight = containerRect.height;

                    const imageAspect = naturalWidth / naturalHeight;
                    const containerAspect = containerWidth / containerHeight;

                    if (imageAspect > containerAspect) {
                        displayWidth = containerWidth;
                        displayHeight = containerWidth / imageAspect;
                        offsetX = 0;
                        offsetY = (containerHeight - displayHeight) / 2;
                    } else {
                        displayWidth = containerHeight * imageAspect;
                        displayHeight = containerHeight;
                        offsetX = (containerWidth - displayWidth) / 2;
                        offsetY = 0;
                    }
                } else {
                    displayWidth = mapImage.offsetWidth;
                    displayHeight = mapImage.offsetHeight;

                    const containerRect = mapContainer.getBoundingClientRect();
                    const imageRect = mapImage.getBoundingClientRect();
                    offsetX = imageRect.left - containerRect.left;
                    offsetY = imageRect.top - containerRect.top;
                }

                const baseScaleX = displayWidth / naturalWidth;
                const baseScaleY = displayHeight / naturalHeight;

                symbols.forEach(symbol => {
                    const dataX = parseFloat(symbol.getAttribute('data-x'));
                    const dataY = parseFloat(symbol.getAttribute('data-y'));

                    const displayX = dataX * baseScaleX + offsetX;
                    const displayY = dataY * baseScaleY + offsetY;

                    const buffer = -10;
                    const withinBounds = (
                        displayX >= (offsetX - buffer) &&
                        displayX <= (offsetX + displayWidth + buffer) &&
                        displayY >= (offsetY - buffer) &&
                        displayY <= (offsetY + displayHeight + buffer)
                    );

                    if (withinBounds) {
                        symbol.style.left = displayX + 'px';
                        symbol.style.top = displayY + 'px';
                        symbol.style.transform = `translate(-50%, -50%)`;
                        if (symbol.style.visibility === 'hidden') {
                            symbol.style.visibility = 'visible';
                        }
                    } else {
                        symbol.style.visibility = 'hidden';
                    }
                });

                rings.forEach(ring => {
                    const dataX = parseFloat(ring.getAttribute('data-x'));
                    const dataY = parseFloat(ring.getAttribute('data-y'));
                    const radius = parseFloat(ring.getAttribute('data-radius'));

                    const displayX = dataX * baseScaleX + offsetX;
                    const displayY = dataY * baseScaleY + offsetY;

                    const withinBounds = (
                        displayX >= offsetX &&
                        displayX <= (offsetX + displayWidth) &&
                        displayY >= offsetY &&
                        displayY <= (offsetY + displayHeight)
                    );

                    if (withinBounds) {
                        ring.style.left = displayX + 'px';
                        ring.style.top = displayY + 'px';

                        const scaledRadius = radius * baseScaleX;
                        ring.style.width = (scaledRadius * 2) + 'px';
                        ring.style.height = (scaledRadius * 2) + 'px';
                        ring.style.transform = `translate(-50%, -50%)`;

                        if (ring.style.visibility === 'hidden') {
                            ring.style.visibility = 'visible';
                        }
                    } else {
                        ring.style.visibility = 'hidden';
                    }
                });
            }

            function removeHidden() {
                document.querySelectorAll('.map-symbol').forEach(sym => {
                    sym.classList.remove('hidden');
                });
                document.querySelectorAll('.map-ring').forEach(ring => {
                    ring.classList.remove('hidden');
                });
            }

            if (mapImage.complete) {
                filterAndShowSymbols();
                repositionSymbols();
                removeHidden()
            }
            mapImage.addEventListener('load', function() {
                filterAndShowSymbols();
                repositionSymbols();
                removeHidden()
            });

            function handleResize() {
                repositionSymbols();
            }

            window.addEventListener('resize', handleResize);

            function updateTransform() {
                mapImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
                mapSymbols.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;

                const symbols = document.querySelectorAll('.map-symbol');
                symbols.forEach(symbol => {
                    symbol.style.transform = `translate(-50%, -50%) scale(${1/currentZoom})`;
                });
                const rings = document.querySelectorAll('.map-ring');
                rings.forEach(ring=> {
                    ring.style.borderWidth = `${2/currentZoom}px`;
                });
                zoomLevelDisplay.textContent = `${Math.round(currentZoom * 100)}%`;
            }

            function constrainTranslation() {
                if (currentZoom <= 1) {
                    translateX = 0;
                    translateY = 0;
                    return;
                }

                const containerRect = mapContainer.getBoundingClientRect();
                const imageWidth = mapImage.offsetWidth * currentZoom;
                const imageHeight = mapImage.offsetHeight * currentZoom;

                const maxTranslateX = Math.max(0, (imageWidth - containerRect.width) / 2);
                const maxTranslateY = Math.max(0, (imageHeight - containerRect.height) / 2);

                translateX = Math.max(-maxTranslateX, Math.min(maxTranslateX, translateX));
                translateY = Math.max(-maxTranslateY, Math.min(maxTranslateY, translateY));
            }

            function zoomIn() {
                if (currentZoom < maxZoom) {
                    currentZoom = Math.min(maxZoom, currentZoom + zoomStep);
                    constrainTranslation();
                }
            }

            function zoomOut() {
                if (currentZoom > minZoom) {
                    currentZoom = Math.max(minZoom, currentZoom - zoomStep);
                    constrainTranslation();
                }
            }

            function resetZoom() {
                currentZoom = 1;
                translateX = 0;
                translateY = 0;
                updateTransform();
            }

            function toggleFullscreen() {
                isFullscreen = !isFullscreen;

                if (isFullscreen) {
                    mapContainer.classList.add('fullscreen');
                    fullscreenBtn.title = 'Exit Fullscreen';
                } else {
                    mapContainer.classList.remove('fullscreen');
                    fullscreenBtn.title = 'Toggle Fullscreen';
                }

                setTimeout(() => {
                    repositionSymbols();
                }, 100);
            }

            function showTooltip(symbol, e) {
                const id = symbol.getAttribute('data-id');
                const comment = symbol.getAttribute('data-comment');
                const lat = symbol.getAttribute('data-lat');
                const lon = symbol.getAttribute('data-lon');
                const bda = symbol.getAttribute('data-bda');
                const debriefId = symbol.getAttribute('data-debrief-id');

                let tooltipContent = '';

                const displayText = comment || id;
                tooltipContent += `<div class="tooltip-comment">${displayText}</div>`;
                if (displayText === comment) {
                    tooltipContent += `<div class="tooltip-comment">${id}-01</div>`;
                }

                if (bda && bda !== 'None' && bda !== '') {
                    tooltipContent += `<div style="color: #90cdf4; font-weight: bold; margin-bottom: 4px;">BDA: ${bda}</div>`;
                }

                if (debriefId && debriefId !== 'None' && debriefId !== '') {
                    tooltipContent += `<div style="color: #98fb98; font-weight: bold; margin-bottom: 4px;">📋 Click for Report</div>`;
                }

                if (lat && lon) {
                    tooltipContent += `<div class="tooltip-coords">LAT: ${lat}<br>LON: ${lon}</div>`;
                }

                symbolTooltip.innerHTML = tooltipContent;
                symbolTooltip.classList.add('show');

                const rect = mapContainer.getBoundingClientRect();
                const x = e.clientX - rect.left + 15;
                const y = e.clientY - rect.top - 10;

                symbolTooltip.style.left = x + 'px';
                symbolTooltip.style.top = y + 'px';
            }

            function hideTooltip() {
                symbolTooltip.classList.remove('show');
            }

            document.querySelectorAll('.map-symbol').forEach(symbol => {
                symbol.addEventListener('mouseenter', function(e) {
                    showTooltip(this, e);
                });

                symbol.addEventListener('mouseleave', hideTooltip);

                symbol.addEventListener('mousemove', function(e) {
                    const rect = mapContainer.getBoundingClientRect();
                    const x = e.clientX - rect.left + 15;
                    const y = e.clientY - rect.top - 10;

                    symbolTooltip.style.left = x + 'px';
                    symbolTooltip.style.top = y + 'px';
                });

                symbol.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const debriefId = this.getAttribute('data-debrief-id');

                    if (debriefId && debriefId !== 'None' && debriefId !== '') {
                        window.location.href = `/debrief/${debriefId}`;
                    } else {
                        const id = this.getAttribute('data-id');
                        const comment = this.getAttribute('data-comment');
                    }
                });
            });

            zoomInBtn.addEventListener('click', function() {
                zoomIn();
                updateTransform();
            });

            zoomOutBtn.addEventListener('click', function() {
                zoomOut();
                updateTransform();
            });

            resetZoomBtn.addEventListener('click', resetZoom);
            fullscreenBtn.addEventListener('click', toggleFullscreen);

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && isFullscreen) {
                    toggleFullscreen();
                }
            });

            mapContainer.addEventListener('wheel', function(e) {
                e.preventDefault();

                const rect = mapContainer.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                const oldZoom = currentZoom;

                if (e.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }

                if (currentZoom !== oldZoom) {
                    if (currentZoom > 1) {
                        const zoomRatio = currentZoom / oldZoom;
                        const containerCenterX = rect.width / 2;
                        const containerCenterY = rect.height / 2;

                        const offsetX = mouseX - containerCenterX;
                        const offsetY = mouseY - containerCenterY;

                        translateX = translateX * zoomRatio - offsetX * (zoomRatio - 1) * 0.1;
                        translateY = translateY * zoomRatio - offsetY * (zoomRatio - 1) * 0.1;

                        constrainTranslation();
                    }
                    updateTransform();
                    updateCursor();
                }
            });

            mapContainer.addEventListener('mousedown', function(e) {
                if (currentZoom > 1) {
                    isDragging = true;
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                    mapContainer.style.cursor = 'grabbing';
                    e.preventDefault();
                }
            });

            document.addEventListener('mousemove', function(e) {
                if (isDragging && currentZoom > 1) {
                    translateX = e.clientX - startX;
                    translateY = e.clientY - startY;
                    constrainTranslation();
                    updateTransform();
                }
            });

            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    mapContainer.style.cursor = currentZoom > 1 ? 'grab' : 'default';
                }
            });

            function updateCursor() {
                if (currentZoom > 1) {
                    mapContainer.style.cursor = isDragging ? 'grabbing' : 'grab';
                } else {
                    mapContainer.style.cursor = 'default';
                }
            }

            let lastTouchDistance = 0;
            let lastTouchX = 0;
            let lastTouchY = 0;

            mapContainer.addEventListener('touchstart', function(e) {
                if (e.touches.length === 1 && currentZoom > 1) {
                    isDragging = true;
                    startX = e.touches[0].clientX - translateX;
                    startY = e.touches[0].clientY - translateY;
                } else if (e.touches.length === 2) {
                    isDragging = false;
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    lastTouchDistance = Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                    lastTouchX = (touch1.clientX + touch2.clientX) / 2;
                    lastTouchY = (touch1.clientY + touch2.clientY) / 2;
                }
                e.preventDefault();
            });

            mapContainer.addEventListener('touchmove', function(e) {
                if (e.touches.length === 1 && isDragging && currentZoom > 1) {
                    translateX = e.touches[0].clientX - startX;
                    translateY = e.touches[0].clientY - startY;
                    constrainTranslation();
                    updateTransform();
                } else if (e.touches.length === 2) {
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );

                    if (lastTouchDistance > 0) {
                        const deltaDistance = currentDistance - lastTouchDistance;

                        if (deltaDistance > 0) {
                            currentZoom = Math.min(maxZoom, currentZoom + zoomStep * 0.5);
                        } else {
                            currentZoom = Math.max(minZoom, currentZoom - zoomStep * 0.5);
                        }

                        constrainTranslation();
                        updateTransform();
                    }

                    lastTouchDistance = currentDistance;
                }
                e.preventDefault();
            });

            mapContainer.addEventListener('touchend', function(e) {
                isDragging = false;
                lastTouchDistance = 0;
            });

            async function captureMapWithCanvas(symbolSizeMultiplier = 1.0) {
                const mapContainer = document.getElementById('mapContainer');
                const mapImage = document.getElementById('mapImage');
                const symbols = document.querySelectorAll('.map-symbol:not([style*="display: none"])');
                const rings = document.querySelectorAll('.map-ring:not([style*="display: none"])');

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                const containerRect = mapContainer.getBoundingClientRect();
                const scale = 2;

                canvas.width = containerRect.width * scale;
                canvas.height = containerRect.height * scale;

                ctx.scale(scale, scale);

                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';

                ctx.fillStyle = '#121212';
                ctx.fillRect(0, 0, containerRect.width, containerRect.height);

                try {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        img.src = mapImage.src;
                    });

                    const transform = getComputedStyle(mapImage).transform;
                    let scaleX = 1, scaleY = 1, translateX = 0, translateY = 0;

                    if (transform && transform !== 'none') {
                        const matrix = new DOMMatrix(transform);
                        scaleX = matrix.a;
                        scaleY = matrix.d;
                        translateX = matrix.e;
                        translateY = matrix.f;
                    }

                    ctx.save();

                    ctx.translate(translateX, translateY);
                    ctx.scale(scaleX, scaleY);

                    const naturalWidth = mapImage.offsetWidth / scaleX;
                    const naturalHeight = mapImage.offsetHeight / scaleY;
                    ctx.drawImage(img, 0, 0, naturalWidth, naturalHeight);

                    ctx.restore();

                    for (const ring of rings) {
                        const ringRect = ring.getBoundingClientRect();
                        const centerX = ringRect.left - containerRect.left + ringRect.width / 2;
                        const centerY = ringRect.top - containerRect.top + ringRect.height / 2;
                        const radius = (ringRect.width / 2) * symbolSizeMultiplier;

                        ctx.strokeStyle = window.getComputedStyle(ring).borderColor || '#ff0000';
                        ctx.lineWidth = Math.max(1, 2 * symbolSizeMultiplier);
                        ctx.globalAlpha = 0.7;
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                        ctx.stroke();
                        ctx.globalAlpha = 1;
                    }

                    const symbolImages = new Map();
                    const uniqueSrcs = [...new Set(Array.from(symbols).map(s => s.src))];

                    await Promise.all(uniqueSrcs.map(src => {
                        return new Promise((resolve) => {
                            if (symbolImages.has(src)) {
                                resolve();
                                return;
                            }
                            const img = new Image();
                            img.crossOrigin = 'anonymous';
                            img.onload = () => {
                                symbolImages.set(src, img);
                                resolve();
                            };
                            img.onerror = () => {
                                console.warn('Failed to load symbol:', src);
                                resolve();
                            };
                            img.src = src;
                        });
                    }));

                    for (const symbol of symbols) {
                        const img = symbolImages.get(symbol.src);
                        if (!img) continue;

                        const symbolRect = symbol.getBoundingClientRect();
                        const baseCenterX = symbolRect.left - containerRect.left + symbolRect.width / 2;
                        const baseCenterY = symbolRect.top - containerRect.top + symbolRect.height / 2;

                        let scaledWidth = symbolRect.width * symbolSizeMultiplier;
                        let scaledHeight = symbolRect.height * symbolSizeMultiplier;

                        const minRenderSize = 12;
                        if (scaledWidth < minRenderSize || scaledHeight < minRenderSize) {
                            const ratio = Math.max(minRenderSize / scaledWidth, minRenderSize / scaledHeight);
                            scaledWidth *= ratio;
                            scaledHeight *= ratio;
                        }

                        const x = baseCenterX - scaledWidth / 2;
                        const y = baseCenterY - scaledHeight / 2;

                        ctx.save();

                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';

                        if (symbol.classList.contains('collision-no-report')) {
                            ctx.filter = 'grayscale(100%) brightness(0.3)';
                        } else if (symbol.classList.contains('collision')) {
                            ctx.filter = 'grayscale(100%) brightness(1.0)';
                        } else if (symbol.classList.contains('destroyed-no-report')) {
                            ctx.filter = 'brightness(0.4) saturate(0.6)';
                        }

                        ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
                        ctx.restore();
                    }

                    const link = document.createElement('a');
                    link.download = `interactive-map-${Date.now()}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                } catch (error) {
                    console.error('Canvas capture failed:', error);
                    throw error;
                }
            }


            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', async function() {
                    try {
                        if (!isFullscreen)
                            await captureMapWithCanvas(0.6);
                        else
                            await captureMapWithCanvas(1.2);
                    } catch (error) {
                        console.error('Canvas capture failed, falling back to simplified method:', error);
                        alert('Failed to capture image. Please try again.');
                    }
                });
            }

            updateTransform();
            updateCursor();
        });

        document.getElementById('loadPresentationBtn').addEventListener('click', function() {
            const container = document.getElementById('presentationContainer');
            const loadWrapper = document.getElementById('presentationLoadWrapper');

            loadWrapper.innerHTML = `
                    <div class="presentation-loading">
                        <div class="loading-spinner"></div>
                        <span>Loading presentation...</span>
                    </div>
                `;

            const iframe = document.createElement('iframe');
            iframe.className = 'presentation-iframe';
            iframe.src = 'https://docs.google.com/presentation/d/e/2PACX-1vQj-u5rSo59uLiGQ7QZNyXvuv4T4xxB5Z9NgLyJNbAfE7vR7mjxe6avClPAfzW1r-ZVFfD4jU75OkLi/pubembed?start=false&loop=false&delayms=3000';
            iframe.frameBorder = '0';
            iframe.allowFullscreen = true;
            iframe.mozAllowFullScreen = true;
            iframe.webkitAllowFullscreen = true;

            iframe.addEventListener('load', function() {
                setTimeout(() => {
                    if (loadWrapper && loadWrapper.parentNode) {
                        loadWrapper.remove();
                    }
                }, 500);
            });

            container.appendChild(iframe);
        });
    </script>
</body>
</html>