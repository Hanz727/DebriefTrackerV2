<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo2.png') }}">
    <title>CVIC MENU</title>

    <style>
        @import url('static/css/color-palette.css');
        @import url('static/css/cvic.css');

        .bda-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
            gap: 10px;
        }

        .bda-card-link {
            text-decoration: none;
            color: inherit;
            display: block;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .bda-card-link:hover {
            transform: translateY(-2px);
            text-decoration: none;
            color: inherit;
        }

        .bda-card-link:hover .bda-card {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-color: #666;
        }

        .bda-card {
            background: #1f1f1f;
            border: 1px solid #4f545c;
            padding: 15px;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .bda-weapon {
            text-transform: uppercase;
            font-weight: bold;
            font-size: var(--font-size-md);
            padding-bottom: 2px;
            white-space: nowrap;
        }

        .bda-target {
            font-size: var(--font-size-sm);
            padding-bottom: 7px;
            white-space: nowrap;
        }

        .bda-id-info {
            font-size: var(--font-size-md);
            text-transform: uppercase;
            white-space: nowrap;
            display: flex;
            justify-content: space-between;
            padding-top: 3px;
        }

        .bda-result {
            font-size: var(--font-size-md);
            white-space: nowrap;
            font-weight: bolder;
        }

        .bda-img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: #121212;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-top: 5px;
            border: 1px solid #4f545c;
            text-align: center;
        }

        .bda-img.loading {
            opacity: 0.7;
        }

        .bda-img.loaded {
            opacity: 1;
        }

        .bda-footer-date {
            text-align: right;
            font-size: var(--font-size-sm);
        }

        .presentation-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Ratio */
            height: 0;
            border: 1px solid #4f545c;
            background: #121212;
        }

        .presentation-container iframe {
            border: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }

        /* Interactive Map Styles */
        .map-container {
            position: relative;
            width: 100%;
            border: 1px solid #4f545c;
            background: #121212;
            overflow: hidden;
            cursor: default;
            max-height: 600px;
            margin-bottom: 10px;
        }

        .map-img {
            width: 100%;
            height: auto;
            display: block;
            transition: none;
            user-select: none;
            -webkit-user-drag: none;
            will-change: transform;
        }

        .map-img.smooth-transition {
            transition: transform 0.2s ease;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }

        .fullscreen-btn {
            width: 40px;
            height: 40px;
            background: rgba(31, 31, 31, 0.9);
            border: 1px solid #4f545c;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        .fullscreen-btn:hover {
            background: rgba(79, 84, 92, 0.9);
        }

        .fullscreen-btn:active {
            background: rgba(100, 100, 100, 0.9);
        }

        /* Fullscreen styles */
        .map-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            max-height: none;
            z-index: 1000;
            border: none;
        }

        .map-container.fullscreen .map-img {
            width: 100%;
            height: 100vh;
            object-fit: contain;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: rgba(31, 31, 31, 0.9);
            border: 1px solid #4f545c;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        .zoom-btn:hover {
            background: rgba(79, 84, 92, 0.9);
        }

        .zoom-btn:active {
            background: rgba(100, 100, 100, 0.9);
        }

        .zoom-level {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(31, 31, 31, 0.9);
            border: 1px solid #4f545c;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            font-family: monospace;
            z-index: 10;
        }

        /* Map Button Styles */
        .map-buttons {
            display: flex;
            width: 100%;
            gap: 0;
            margin-bottom: 20px;
        }

        .map-button {
            flex: 1;
            padding: 12px 16px;
            background: #1f1f1f;
            border: 1px solid #4f545c;
            color: white;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            user-select: none;
        }

        .map-button:not(:last-child) {
            border-right: none;
        }

        .map-button:hover {
            background: #2a2a2a;
            border-color: #666;
        }

        .map-button:active {
            background: #333;
        }

        .map-button.active {
            background: #4f545c;
            border-color: #666;
        }

        /* SACT Sub-menu Styles */
        .sact-submenu {
            display: none;
            flex-wrap: wrap;
            width: 100%;
            gap: 0;
            margin-bottom: 10px;
            animation: slideDown 0.3s ease-out;
        }

        .sact-submenu.show {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sact-button {
            flex: 1;
            min-width: calc(100% / 6);
            padding: 8px 12px;
            background: #2a2a2a;
            border: 1px solid #666;
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            user-select: none;
        }

        .sact-button:not(:last-child) {
            border-right: none;
        }

        .sact-button:hover {
            background: #3a3a3a;
            border-color: #777;
        }

        .sact-button:active {
            background: #444;
        }

        .sact-button.active {
            background: #666;
            border-color: #888;
        }

        /* ===== Responsive Design ===== */
        @media (max-width: 768px) {
            .sidebar {
                position: relative;
                width: 100%;
                max-height: none;
            }

            .main-layout {
                flex-direction: column;
            }

            .footer {
                margin-left: 0;
            }

            .container {
                margin: 0;
                border: none;
            }

            body {
                padding: 0;
            }

            .map-container {
                max-height: 400px;
            }

            .fullscreen-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }

            .map-button {
                font-size: 12px;
                padding: 10px 8px;
            }

            .sact-button {
                min-width: calc(100% / 3);
                font-size: 11px;
                padding: 6px 8px;
            }
        }

        @media (max-width: 480px) {
            .sact-button {
                min-width: calc(100% / 2);
                font-size: 10px;
                padding: 6px 4px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <img src="/static/img/logo2.png" class="header-logo" alt="CVW-17 Logo">
            <div class="title">CVIC MENU</div>
            <div class="subtitle">CARRIER AIR WING 17</div>
        </div>

        <!-- Main layout with sidebar and content -->
        <div class="main-layout">
            <!-- Sidebar Navigation -->
            <div class="sidebar">
                <a href="#" class="nav-link">HOME</a>
                <a href="/reports" class="nav-link">AP STRIKE REPORTS</a>
                <a href="/dmpi_db" class="nav-link">DMPI DATABASE</a>
                <a href="/viewer" class="nav-link">DATA VIEWER</a>
                <a href="/tacview" class="nav-link">TACVIEW</a>
                <a href="/tracks" class="nav-link">REPLAYS</a>
                <a href="https://virtualcvw17.com/" class="nav-link">CVW-17 WEBSITE</a>
            </div>

            <!-- Content Area -->
            <div class="main-content">
                <div class="content">
                    <div class="content-title">STRATEGIC AIR CAMPAIGN TARGETS</div>
                    <div class="divider"></div>

                    <div class="map-container" id="mapContainer">
                        <img class="map-img" id="mapImage" src="/static/maps/interactive_map-air-defence.png" alt="Strategic Map">
                        <div class="map-controls">
                            <button class="fullscreen-btn" id="fullscreenBtn" title="Toggle Fullscreen">⛶</button>
                            <button class="zoom-btn" id="zoomIn" title="Zoom In">+</button>
                            <button class="zoom-btn" id="zoomOut" title="Zoom Out">−</button>
                            <button class="zoom-btn" id="resetZoom" title="Reset Zoom">⌂</button>
                        </div>
                        <div class="zoom-level" id="zoomLevel">100%</div>
                    </div>

                    <!-- Map Selection Buttons -->
                    <div class="map-buttons">
                        <button class="map-button active" data-map="air-defence">AIR DEFENCE</button>
                        <button class="map-button" data-map="super-mez">SUPER MEZ</button>
                        <button class="map-button" data-map="sact-all" id="sactMainButton">STRATEGIC AIR CAMPAIGN TARGETS</button>
                    </div>

                    <!-- SACT Sub-menu -->
                    <div class="sact-submenu" id="sactSubmenu">
                        <button class="sact-button active" data-map="sact-all">ALL</button>
                        <button class="sact-button" data-map="sact-c">C</button>
                        <button class="sact-button" data-map="sact-l">L</button>
                        <button class="sact-button" data-map="sact-ccc">CCC</button>
                        <button class="sact-button" data-map="sact-e">E</button>
                        <button class="sact-button" data-map="sact-o">O</button>
                        <button class="sact-button" data-map="sact-rr">RR</button>
                        <button class="sact-button" data-map="sact-a">A</button>
                        <button class="sact-button" data-map="sact-n">N</button>
                        <button class="sact-button" data-map="sact-ms">MS</button>
                        <button class="sact-button" data-map="sact-sc">SC</button>
                        <button class="sact-button" data-map="sact-rg">RG</button>
                    </div>

                    <!-- Deployment Presentation Section -->
                    <div class="content-title" style="margin-top: 40px">DEPLOYMENT PRESENTATION</div>
                    <div class="divider"></div>

                    <div class="presentation-container">
                        <iframe class="presentation-iframe"
                                src="https://docs.google.com/presentation/d/e/2PACX-1vQj-u5rSo59uLiGQ7QZNyXvuv4T4xxB5Z9NgLyJNbAfE7vR7mjxe6avClPAfzW1r-ZVFfD4jU75OkLi/pubembed?start=false&loop=false&delayms=3000"
                                frameborder="0"
                                allowfullscreen="true"
                                mozallowfullscreen="true"
                                webkitallowfullscreen="true">
                        </iframe>
                    </div>

                    <div class="content-title" style="margin-top: 40px;">LATEST BDA</div>

                    <div class="divider"></div>

                    <div class="bda-grid">
                        {% for bda in bdas if bda['img-src'] %}
                            <a href="/debrief/{{ bda['id'] }}" class="bda-card-link">
                                <div class="bda-card">
                                    <div class="bda-weapon">{{ bda['weapon'] }}</div>
                                    <div class="bda-target">{{ bda['target'] }}</div>
                                    <div class="bda-result">{{ bda['bda-result'] }}</div>
                                    <img class="bda-img loading"
                                         alt="NO BDA IMG"
                                         src="/static/img/img-placeholder.webp"
                                         data-src="{{ bda['img-src'] }}"
                                         data-index="{{ loop.index0 }}">
                                    <div class="bda-id-info">
                                        <div>{{ bda['msn-nr'] }}</div>
                                        <div>-</div>
                                        <div>{{ bda['callsign'] }}</div>
                                        <div>-</div>
                                        <div>{{ bda['msn-evt'] }}</div>
                                    </div>
                                    <div class="bda-footer-date">{{ bda['date'] }}</div>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                </div>

            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <img src="/static/img/logo2.png" width="80" height="72" alt="CVW-17 Logo" class="footer-logo">
            <div class="footer-text">
                <div class="title">VIRTUAL CARRIER AIR WING 17</div>
                <div class="subtitle">Not associated with the Department of Defence or any of its components.</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // BDA Images lazy loading (existing functionality)
            const bdaImages = document.querySelectorAll('.bda-img[data-src]');

            function loadImage(img) {
                const actualSrc = img.getAttribute('data-src');
                if (!actualSrc || actualSrc === '/static/img/img-placeholder.webp') {
                    return;
                }
                if (img.src === actualSrc) {
                    return;
                }

                const tempImg = new Image();
                tempImg.onload = function() {
                    img.src = actualSrc;
                    img.classList.remove('loading');
                    img.classList.add('loaded');
                };
                tempImg.onerror = function() {
                    img.classList.remove('loading');
                };
                tempImg.src = actualSrc;
            }

            function unloadImage(img) {
                const actualSrc = img.getAttribute('data-src');
                if (img.src !== window.location.origin + '/static/img/img-placeholder.webp' &&
                    actualSrc && actualSrc !== '/static/img/img-placeholder.webp') {
                    img.src = '/static/img/img-placeholder.webp';
                    img.classList.add('loading');
                    img.classList.remove('loaded');
                }
            }

            const loadObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        loadImage(img);
                    }
                });
            }, {
                rootMargin: '400px 0px',
                threshold: 0.01
            });

            const unloadObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) {
                        const img = entry.target;
                        unloadImage(img);
                    }
                });
            }, {
                rootMargin: '1600px 0px',
                threshold: 0
            });

            bdaImages.forEach(img => {
                loadObserver.observe(img);
                unloadObserver.observe(img);
            });

            // Map Button Functionality
            const mapButtons = document.querySelectorAll('.map-button');
            const sactButtons = document.querySelectorAll('.sact-button');
            const mapImage = document.getElementById('mapImage');
            const sactSubmenu = document.getElementById('sactSubmenu');
            const sactMainButton = document.getElementById('sactMainButton');

            // Map sources for different button types
            const mapsPath = '/static/maps/interactive_map-';

            // Main map buttons functionality
            mapButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all main buttons
                    mapButtons.forEach(btn => btn.classList.remove('active'));

                    // Add active class to clicked button
                    this.classList.add('active');

                    const mapType = this.getAttribute('data-map');

                    // Show/hide SACT submenu
                    if (mapType === 'sact-all') {
                        sactSubmenu.classList.add('show');
                        // Set the first SACT button (ALL) as active
                        sactButtons.forEach(btn => btn.classList.remove('active'));
                        sactButtons[0].classList.add('active');
                    } else {
                        sactSubmenu.classList.remove('show');
                    }

                    // Change map image source
                    mapImage.src = mapsPath + mapType + '.png';

                    // Reset zoom when changing maps
                    resetZoom();
                });
            });

            // SACT sub-buttons functionality
            sactButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all SACT buttons
                    sactButtons.forEach(btn => btn.classList.remove('active'));

                    // Add active class to clicked button
                    this.classList.add('active');

                    // Change map image source
                    const mapType = this.getAttribute('data-map');
                    mapImage.src = mapsPath + mapType + '.png';

                    // Don't reset zoom for SACT sub-categories - keep current zoom level
                });
            });

            // Interactive Map Functionality
            const mapContainer = document.getElementById('mapContainer');
            const zoomInBtn = document.getElementById('zoomIn');
            const zoomOutBtn = document.getElementById('zoomOut');
            const resetZoomBtn = document.getElementById('resetZoom');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const zoomLevelDisplay = document.getElementById('zoomLevel');

            let currentZoom = 1;
            let isDragging = false;
            let startX = 0;
            let startY = 0;
            let translateX = 0;
            let translateY = 0;
            let isFullscreen = false;

            const minZoom = 1;
            const maxZoom = 4;
            const zoomStep = 0.2;

            function updateTransform(useTransition = false) {
                if (useTransition) {
                    mapImage.classList.add('smooth-transition');
                } else {
                    mapImage.classList.remove('smooth-transition');
                }
                mapImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
                zoomLevelDisplay.textContent = `${Math.round(currentZoom * 100)}%`;
            }

            function constrainTranslation() {
                if (currentZoom <= 1) {
                    translateX = 0;
                    translateY = 0;
                    return;
                }

                const containerRect = mapContainer.getBoundingClientRect();
                const imageWidth = mapImage.offsetWidth * currentZoom;
                const imageHeight = mapImage.offsetHeight * currentZoom;

                const maxTranslateX = Math.max(0, (imageWidth - containerRect.width) / 2);
                const maxTranslateY = Math.max(0, (imageHeight - containerRect.height) / 2);

                translateX = Math.max(-maxTranslateX, Math.min(maxTranslateX, translateX));
                translateY = Math.max(-maxTranslateY, Math.min(maxTranslateY, translateY));
            }

            function zoomIn() {
                if (currentZoom < maxZoom) {
                    currentZoom = Math.min(maxZoom, currentZoom + zoomStep);
                    constrainTranslation();
                    updateTransform(true);
                }
            }

            function zoomOut() {
                if (currentZoom > minZoom) {
                    currentZoom = Math.max(minZoom, currentZoom - zoomStep);
                    constrainTranslation();
                    updateTransform(true);
                }
            }

            function resetZoom() {
                currentZoom = 1;
                translateX = 0;
                translateY = 0;
                updateTransform(true);
            }

            function toggleFullscreen() {
                isFullscreen = !isFullscreen;

                if (isFullscreen) {
                    mapContainer.classList.add('fullscreen');
                    fullscreenBtn.innerHTML = '⛶';
                    fullscreenBtn.title = 'Exit Fullscreen';
                } else {
                    mapContainer.classList.remove('fullscreen');
                    fullscreenBtn.innerHTML = '⛶';
                    fullscreenBtn.title = 'Toggle Fullscreen';
                }

                // Recalculate constraints after fullscreen toggle
                setTimeout(() => {
                    constrainTranslation();
                    updateTransform(true);
                }, 100);
            }

            // Button event listeners
            zoomInBtn.addEventListener('click', zoomIn);
            zoomOutBtn.addEventListener('click', zoomOut);
            resetZoomBtn.addEventListener('click', resetZoom);
            fullscreenBtn.addEventListener('click', toggleFullscreen);

            // ESC key to exit fullscreen
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && isFullscreen) {
                    toggleFullscreen();
                }
            });

            // Mouse wheel zoom
            mapContainer.addEventListener('wheel', function(e) {
                e.preventDefault();

                const rect = mapContainer.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                const oldZoom = currentZoom;

                if (e.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }

                // Adjust translation to zoom towards mouse position
                if (currentZoom !== oldZoom && currentZoom > 1) {
                    const zoomRatio = currentZoom / oldZoom;
                    const containerCenterX = rect.width / 2;
                    const containerCenterY = rect.height / 2;

                    const offsetX = mouseX - containerCenterX;
                    const offsetY = mouseY - containerCenterY;

                    translateX = translateX * zoomRatio - offsetX * (zoomRatio - 1) * 0.1;
                    translateY = translateY * zoomRatio - offsetY * (zoomRatio - 1) * 0.1;

                    constrainTranslation();
                    updateTransform(true);
                    updateCursor();
                }
            });

            // Mouse drag functionality
            mapContainer.addEventListener('mousedown', function(e) {
                if (currentZoom > 1) {
                    isDragging = true;
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                    mapContainer.style.cursor = 'grabbing';
                    e.preventDefault();
                }
            });

            document.addEventListener('mousemove', function(e) {
                if (isDragging && currentZoom > 1) {
                    translateX = e.clientX - startX;
                    translateY = e.clientY - startY;
                    constrainTranslation();
                    updateTransform(false);
                }
            });

            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    mapContainer.style.cursor = currentZoom > 1 ? 'grab' : 'default';
                }
            });

            // Update cursor when zoom changes
            function updateCursor() {
                if (currentZoom > 1) {
                    mapContainer.style.cursor = isDragging ? 'grabbing' : 'grab';
                } else {
                    mapContainer.style.cursor = 'default';
                }
            }

            // Touch support for mobile
            let lastTouchDistance = 0;
            let lastTouchX = 0;
            let lastTouchY = 0;

            mapContainer.addEventListener('touchstart', function(e) {
                if (e.touches.length === 1 && currentZoom > 1) {
                    isDragging = true;
                    startX = e.touches[0].clientX - translateX;
                    startY = e.touches[0].clientY - translateY;
                } else if (e.touches.length === 2) {
                    isDragging = false;
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    lastTouchDistance = Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                    lastTouchX = (touch1.clientX + touch2.clientX) / 2;
                    lastTouchY = (touch1.clientY + touch2.clientY) / 2;
                }
                e.preventDefault();
            });

            mapContainer.addEventListener('touchmove', function(e) {
                if (e.touches.length === 1 && isDragging && currentZoom > 1) {
                    translateX = e.touches[0].clientX - startX;
                    translateY = e.touches[0].clientY - startY;
                    constrainTranslation();
                    updateTransform();
                } else if (e.touches.length === 2) {
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );

                    if (lastTouchDistance > 0) {
                        const deltaDistance = currentDistance - lastTouchDistance;
                        const oldZoom = currentZoom;

                        if (deltaDistance > 0) {
                            currentZoom = Math.min(maxZoom, currentZoom + zoomStep * 0.5);
                        } else {
                            currentZoom = Math.max(minZoom, currentZoom - zoomStep * 0.5);
                        }

                        constrainTranslation();
                        updateTransform();
                    }

                    lastTouchDistance = currentDistance;
                }
                e.preventDefault();
            });

            mapContainer.addEventListener('touchend', function(e) {
                isDragging = false;
                lastTouchDistance = 0;
            });

            // Initialize
            updateTransform(false);
            updateCursor();
        });
    </script>
</body>
</html>