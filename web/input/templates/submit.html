<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo2.png') }}">
    <title>CVW POST STRIKE AP REPORT</title>
    <style>
        /* ===== CSS Variables for Global Theme ===== */
        :root {
            /* Primary Colors */
            --color-primary: #5865f2;
            --color-primary-hover: #4752c4;
            --color-success: #00ff00;
            --color-danger: #ff5f57;
            --color-danger-hover: #ff4136;

            /* Background Colors */
            --bg-main: #303030;
            --bg-container: #121212;
            --bg-section: #1f1f1f;
            --bg-input: #121212;
            --bg-card: #36393f;
            --bg-input-disabled: #0a0a0a;

            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: #dcddde;
            --text-muted: #b9bbbe;

            /* Border Colors */
            --border-primary: #4f545c;
            --border-secondary: #40444b;
            --border-container: #202225;

            /* Spacing */
            --spacing-xs: 5px;
            --spacing-sm: 8px;
            --spacing-md: 15px;
            --spacing-lg: 20px;
            --spacing-xl: 30px;

            /* Typography */
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-size-xs: 10px;
            --font-size-sm: 12px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-xxl: 20px;
            --font-size-title: 32px;

            /* Common Dimensions */
            --input-height: 37px;
            --max-container-width: 1200px;
            --pilot-card-width: 300px;
        }

        /* ===== Global Reset & Base Styles ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family), serif;
            background: var(--bg-main);
            color: var(--text-secondary);
            min-height: 100vh;
            padding: var(--spacing-lg);
        }

        /* ===== Layout Components ===== */
        .container {
            max-width: var(--max-container-width);
            margin: 0 auto;
            background: var(--bg-container);
            border: 1px solid var(--border-container);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        .header {
            background: var(--bg-section);
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-secondary);
            text-align: center;
            position: relative;
        }

        .header-logo {
            position: absolute;
            left: var(--spacing-xl);
            top: 50%;
            transform: translateY(-50%);
            width: 80px;
            height: 72px;
        }

        .content {
            padding: var(--spacing-xl);
        }

        /* ===== Typography ===== */
        .title {
            font-size: var(--font-size-title);
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: var(--font-size-md);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-title {
            font-size: var(--font-size-xl);
            font-weight: bold;
            color: var(--text-primary);
            margin: var(--spacing-xl) 0 var(--spacing-md) 0;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--border-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ===== Form Elements ===== */
        .field-group {
            display: flex;
            flex-direction: column;
        }

        .field-label {
            font-weight: bold;
            color: var(--text-muted);
            margin-bottom: var(--spacing-xs);
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-left: 2px;
        }

        .field-value {
            background: var(--bg-input);
            padding: 0 12px;
            border: 1px solid var(--border-primary);
            align-content: center;
            color: var(--text-primary);
            font-size: var(--font-size-md);
            height: var(--input-height);
        }

        .field-value-aircrew {
            background: var(--bg-input);
            text-align: center;
            padding: 0 5px;
            align-content: center;
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            font-size: clamp(10px, 1.3vw, 14px);
            height: var(--input-height);
            width: 100%;
        }

        .field-value-aircrew:disabled {
            background: var(--bg-input-disabled);
            border: 1px solid var(--border-primary);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ===== Grid Layouts ===== */
        .mission-header {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-md);
            margin-bottom: 10px;
            background: var(--bg-section);
            padding: 10px;
            border: 1px solid var(--border-primary);
        }

        .pilots-grid {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .ag-grid {
            display: flex;
            gap: 10px;
            justify-content: center;
            width: 100%;
        }

        .bda-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        /* ===== Card Components ===== */
        .pilot-card {
            background: var(--bg-section);
            border: 1px solid var(--border-primary);
            padding: 7px 10px 10px;
            width: 100%;
            max-width: var(--pilot-card-width);
            position: relative;
        }

        .weapon-card {
            background: var(--bg-input);
            border: 1px solid var(--border-primary);
            padding: var(--spacing-md);
            position: relative;
        }

        .bda-card {
            background: var(--bg-section);
            border: 1px solid var(--border-primary);
            padding: var(--spacing-md);
        }

        /* ===== Buttons ===== */
        .btn-primary {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-size: var(--font-size-sm);
            text-transform: uppercase;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-primary:disabled {
            background: var(--border-primary);
            cursor: not-allowed;
        }

        .btn-add {
            background: transparent;
            border: 2px dashed transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            flex: 1;
            min-width: 0;
            height: 100px;
        }

        .btn-add:hover {
            border-color: var(--color-success) !important;
            background: rgba(0, 255, 0, 0.1);
            opacity: 1 !important;
        }

        .btn-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 16px;
            height: 16px;
            background: var(--color-danger);
            border: none;
            color: white;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            opacity: 0;
            pointer-events: none;
        }

        .btn-remove:hover {
            background: var(--color-danger-hover);
            transform: scale(1.1);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        .btn-remove:active {
            transform: scale(0.95);
        }

        /* ===== Interactive States ===== */
        .pilots-grid:hover .btn-add,
        .ag-grid-vertical-box:hover .btn-add {
            opacity: 0.6;
            border-color: var(--border-primary);
        }

        .pilot-card:hover .btn-remove,
        .weapon-card:hover .btn-remove {
            opacity: 1;
            pointer-events: auto;
        }

        .aa-table tr:hover .aa-remove-btn {
            opacity: 1;
        }

        /* ===== Specific Components ===== */
        .callsign-name {
            font-size: var(--font-size-lg);
            font-weight: bold;
            text-align: center;
            margin-bottom: var(--spacing-xs);
            padding-bottom: var(--spacing-xs);
        }

        .pilot-details {
            display: grid;
            grid-template-columns: 1fr 2.8fr;
            gap: var(--spacing-xs);
        }

        .ag-grid-vertical {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            max-width: var(--pilot-card-width);
            gap: 10px;
        }

        .ag-grid-vertical-box {
            background: var(--bg-section);
            border: 1px solid var(--border-primary);
            width: 100%;
            max-width: var(--pilot-card-width);
            padding: 7px 10px 10px;
            justify-items: center;
            position: relative;
        }

        .ag-grid-header {
            text-align: center;
            padding-bottom: var(--spacing-xs);
            font-weight: bold;
        }

        /* ===== File Upload ===== */
        .file-upload-area {
            width: 100%;
            aspect-ratio: 1;
            background: var(--bg-input);
            border: 2px dashed var(--border-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .file-upload-area:hover {
            border-color: var(--color-primary);
            background: #1a1a1a;
        }

        .file-upload-area.dragover {
            border-color: var(--color-success);
            background: rgba(0, 255, 0, 0.1);
        }

        .file-upload-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .file-upload-controls {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            text-align: center;
            z-index: 1;
            background: rgba(18, 18, 18, 0.85);
            padding: 12px;
            border: 1px solid var(--border-primary);
        }

        .file-upload-button {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 8px 12px;
            font-size: 11px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .file-upload-button:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }

        .file-upload-button:active {
            transform: translateY(0);
        }

        .image-overlay-controls {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            z-index: 2;
            display: flex;
            flex-direction: column;
            gap: 4px;
            opacity: 0;
        }

        .file-upload-area:hover .image-overlay-controls {
            opacity: 1;
        }

        .overlay-button {
            background: rgba(18, 18, 18, 0.9);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .overlay-button:hover {
            background: var(--color-primary);
            border-color: var(--color-primary);
            transform: translateY(-1px);
        }

        .overlay-button.danger {
            background: rgba(255, 95, 87, 0.9);
            border-color: var(--color-danger);
        }

        .overlay-button.danger:hover {
            background: var(--color-danger-hover);
            border-color: var(--color-danger-hover);
        }

        /* ===== Tables ===== */
        .aa-grid {
            background: var(--bg-section);
            border: 1px solid var(--border-primary);
            padding: 7px 10px 10px;
        }

        .aa-table {
            width: 100%;
            text-align: center;
            border-collapse: collapse;
            position: relative;
        }

        .aa-table td {
            background: var(--bg-input);
            border: 1px solid var(--border-primary);
            padding: 0 5px;
        }

        .aa-table th {
            padding: 0 5px 10px;
        }

        .aa-table th:last-child {
            width: 60px;
        }

        .aa-remove-btn {
            width: 20px;
            height: 20px;
            background: var(--color-danger);
            border: none;
            color: white;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            margin: 0 auto;
        }

        .aa-remove-btn:hover {
            background: var(--color-danger-hover);
            transform: scale(1.1);
        }

        /* ===== Modal/Popup ===== */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .popup-content {
            background: var(--bg-section);
            border: 1px solid var(--border-primary);
            padding: var(--spacing-xl);
            width: 400px;
            max-width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        .popup-title {
            font-size: var(--font-size-xxl);
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
            text-align: center;
        }

        .popup-field-group {
            margin-bottom: var(--spacing-lg);
        }

        .popup-select {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 10px;
            font-size: var(--font-size-md);
        }

        .popup-button {
            width: 100%;
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 12px;
            font-size: var(--font-size-md);
            text-transform: uppercase;
            cursor: pointer;
        }

        .popup-button:hover {
            background: var(--color-primary-hover);
        }

        .popup-button:disabled {
            background: var(--border-primary);
            cursor: not-allowed;
        }

        /* ===== Misc Components ===== */
        .notes-content {
            background: var(--bg-section);
            padding: var(--spacing-lg);
            border: 1px solid #4a5568;
            color: #e2e8f0;
            line-height: 1.6;
            font-size: var(--font-size-md);
            width: 100%;
            min-height: 120px;
            resize: none;
        }

        .timestamp {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            text-align: right;
        }

        .add-icon {
            font-size: 24px;
            color: var(--border-primary);
        }

        .btn-add:hover .add-icon {
            color: var(--color-success);
            transform: scale(1.2);
        }

        .hidden-file-input {
            display: none;
        }

        /* ===== Specific Element Styles ===== */
        .weapon-name {
            font-weight: bold;
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-sm);
        }

        .target-name {
            font-size: var(--font-size-sm);
            margin-bottom: 14px;
            letter-spacing: 0.5px;
        }

        .aircraft-callsign {
            font-weight: bold;
            font-size: var(--font-size-md);
            margin-bottom: var(--spacing-sm);
        }

        .target-dmpi-table {
            display: grid;
            grid-template-columns: 1fr 3fr;
        }

        .btn-load-json {
            background: var(--color-success);
            margin-right: 10px;
        }

        /* ===== Responsive Design ===== */
        @media (max-width: 768px) {
            .footer-content {
                flex-direction: column;
                gap: var(--spacing-md);
            }

            .footer-title {
                font-size: var(--font-size-lg);
            }

            .footer-subtitle {
                font-size: 11px;
            }
        }

        .btn-load-modex {
            position: absolute;
            top: 25px;
            right: 5px;
            width: 16px;
            height: 16px;
            background: var(--color-primary);
            border: none;
            color: white;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            opacity: 0;
            pointer-events: none;
        }

        .btn-load-modex:hover {
            background: var(--color-primary-hover);
            transform: scale(1.1);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        .pilot-card:hover .btn-load-modex {
            opacity: 1;
            pointer-events: auto;
        }

        .pilot-card[data-loaded-from-json="true"] .btn-load-modex {
            display: none !important;
        }

        .sidebar {
            max-width: 1200px;
            margin: 0 auto 10px auto;
            display: flex;
            justify-content: center;
            gap: 2px;
            background: #1f1f1f;
            border: 1px solid #202225;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        .nav-link {
            background: #121212;
            color: #dcddde;
            text-decoration: none;
            padding: 15px 20px;
            border: 1px solid #4f545c;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            flex: 1;
            text-align: center;
        }

        .nav-link:hover {
            background: #5865f2;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Callsign Selection Modal -->
    <div id="callsignPopup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-title">SETTINGS</div>

            <div class="popup-field-group">
                <div class="field-label">CALLSIGN</div>
                <select id="callsignSelect" class="popup-select">
                    <option value="">-- Select Callsign --</option>
                    <option value="VICTORY1">VICTORY11</option>
                    <option value="BONES2">BONES21</option>
                    <option value="SLUGGER3">SLUGGER31</option>
                    <option value="VANQUISH4">VANQUISH41</option>
                    <option value="JOKER1">JOKER11</option>
                    <option value="BLASTER2">BLASTER21</option>
                    <option value="TRICKER3">TRICKER31</option>
                    <option value="SMOKE4">SMOKE41</option>
                    <option value="LINER1">LINER11</option>
                    <option value="INFERNO2">INFERNO21</option>
                    <option value="ZAPPER3">ZAPPER31</option>
                    <option value="CRUSADER4">CRUSADER41</option>
                </select>
            </div>
            <div class="popup-field-group">
                <div class="field-label">MISSION DATA</div>
                <select id="missionDataSelect" class="popup-select">
                </select>
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="manualButton" class="popup-button" style="flex: 1;" disabled>MANUAL ENTRY</button>
                <button id="loadButton" class="popup-button" style="flex: 1;" disabled>LOAD</button>
            </div>
        </div>
    </div>

    <datalist id="aa-weapons">
        <option value="AIM-54C-Mk60"></option>
        <option value="AIM-120C"></option>
        <option value="AIM-9M"></option>
        <option value="AIM-7P"></option>
        <option value="AIM-7MH"></option>
        <option value="GUN"></option>
    </datalist>

    <div class="sidebar">
        <a href="/" class="nav-link">HOME</a>
        <a href="/reports" class="nav-link">AP STRIKE REPORTS</a>
        <a href="/viewer" class="nav-link">DATA VIEWER</a>
        <a href="/tacview" class="nav-link">TACVIEW</a>
        <a href="/tracks" class="nav-link">REPLAYS</a>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <img src="/static/img/logo2.png" class="header-logo" alt="CVW-17 Logo">
            <div class="title">AP POST STRIKE REPORT</div>
            <div class="subtitle">CARRIER AIR WING 17</div>
        </div>

        <!-- Content -->
        <div class="content">
            <form id="apStrikeForm" name="apStrikeForm">
                <!-- Mission Header -->
                <div class="mission-header">
                    <div class="field-group">
                        <div class="field-label">Mission Name*</div>
                        <input type="text" required minlength="3" maxlength="32"
                               class="field-value-aircrew" style="text-align: left; padding: 0px 12px;"
                               name="mission_name" id="mission_name">
                    </div>
                    <div class="field-group">
                        <div class="field-label">Mission Number*</div>
                        <input type="number" required min="1000" max="9999"
                               class="field-value" name="mission_number" id="mission_number">
                    </div>
                    <div class="field-group">
                        <div class="field-label">Event*</div>
                        <input type="text" required minlength="3" maxlength="3"
                               class="field-value" name="mission_event" id="mission_event">
                    </div>
                    <div class="field-group">
                        <div class="field-label">Date*</div>
                        <input type="date" required style="color-scheme: dark;"
                               class="field-value" name="mission_date" id="mission_date">
                    </div>
                </div>

                <input type="hidden" name="callsign" id="callsign" value="">

                <!-- Aircrew Section -->
                <div class="pilots-grid" id="aircrew">
                    <button type="button" class="btn-add" onclick="addPilotCard()">
                        <span class="add-icon">+</span>
                    </button>

                    <div class="pilot-card" data-pilot-id="1">
                        <button type="button" class="btn-load-modex" onclick="loadDataByModex(1)" title="Load by Modex" style="display: none;">↓</button>
                        <div class="callsign-name">CALLSIGN1</div>
                        <div class="pilot-details">
                            <div>
                                <div class="field-label" style="text-align: center; padding-left: 0px;">MODEX*</div>
                                <input type="text" required pattern="\d{3}"
                                       class="field-value-aircrew" name="aircrew[1][modex]" id="aircrew_1_modex">
                            </div>
                            <div>
                                <div class="field-label" style="text-align: center; padding-left: 0px;">AIRCREW</div>
                                <div style="display: flex;">
                                    <input type="text" required minlength="2" maxlength="32"
                                           class="field-value-aircrew" placeholder="Pilot*" name="aircrew[1][pilot]" id="aircrew_1_pilot">
                                    <input type="text" minlength="2" maxlength="32"
                                           class="field-value-aircrew" placeholder="Rio" name="aircrew[1][rio]" id="aircrew_1_rio">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn-add" onclick="addPilotCard()">
                        <span class="add-icon">+</span>
                    </button>
                </div>

                <!-- A/G Ordnance Section -->
                <div class="section-title">A/G ORDNANCE EXPENDED</div>
                <div class="ag-grid" id="ag-grid">
                    <div class="ag-grid-vertical-box" data-ag-pilot-id="1">
                        <div class="ag-grid-vertical" id="ag-vertical-1">
                            <div class="ag-grid-header">CALLSIGN1</div>
                            <button type="button" class="btn-add" onclick="addWeaponCard(1)" style="height: 120px;">
                                <span class="add-icon">+</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- BDA Section -->
                <div class="section-title">MISSION SUCCESS / BDA</div>
                <div class="bda-grid" id="bda-grid"></div>

                <!-- Opposition Section -->
                <div class="section-title">OPPOSITION ENCOUNTERED</div>
                <div class="mission-header">
                    <div class="field-group">
                        <div class="field-label">TYPE/NUMBER</div>
                        <input type="text" class="field-value" name="opposition_type_number" id="opposition_type_number">
                    </div>
                    <div class="field-group">
                        <div class="field-label">LOCATION</div>
                        <input type="text" class="field-value" name="opposition_location" id="opposition_location">
                    </div>
                </div>

                <!-- A/A Weapons Section -->
                <div class="section-title">A/A WEAPONS EMPLOYED</div>
                <div class="aa-grid">
                    <table class="aa-table">
                        <thead>
                            <tr>
                                <th>MODEX*</th>
                                <th>WEAPON*</th>
                                <th>TARGET*</th>
                                <th>RANGE</th>
                                <th>OWN SPEED (MACH)</th>
                                <th>OWN ALTITUDE</th>
                                <th>TARGET ALTITUDE</th>
                                <th>HIT</th>
                                <th style="border: none; background: transparent; padding: 0; width: 25px;"></th>
                            </tr>
                        </thead>
                        <tbody id="aa-table-body"></tbody>
                    </table>
                    <button type="button" class="btn-add" onclick="addAARow()"
                            style="margin-top: 10px; height: 40px; opacity: 0.6; width: 100%;">
                        <span class="add-icon">+</span>
                    </button>
                </div>

                <!-- Engagement Result Section -->
                <div class="section-title">ENGAGEMENT RESULT</div>
                <select class="field-value" style="width: 300px; background: var(--bg-section);"
                        name="engagement_result" id="engagement_result">
                    <option value="">Select Result...</option>
                    <option value="1 - Enemy Destroyed">1 - Enemy Destroyed</option>
                    <option value="2 - Enemy Escaped">2 - Enemy Escaped</option>
                    <option value="3 - Unknown">3 - Unknown</option>
                    <option value="4 - Friendly Lost / Damaged">4 - Friendly Lost / Damaged</option>
                </select>

                <!-- Blue Casualties Section -->
                <div class="section-title">BLUE CASUALTIES / LOCATION</div>
                <textarea class="notes-content" style="min-height: 60px;"
                          name="blue_casualties" id="blue_casualties"></textarea>

                <!-- Mission Notes Section -->
                <div class="section-title">MISSION NOTES</div>
                <textarea class="notes-content" style="min-height: 60px;"
                          name="mission_notes" id="mission_notes"></textarea>

                <!-- Restrike Recommendation Section -->
                <div class="section-title">RESTRIKE RECOMMENDATION</div>
                <select class="field-value" style="width: 300px; background: var(--bg-section);"
                        name="restrike_recommendation" id="restrike_recommendation">
                    <option value="">Select Recommendation...</option>
                    <option value="1 - No Restrike Recommended">1 - No Restrike Recommended</option>
                    <option value="2 - Possible Restrike Recommended">2 - Possible Restrike Recommended</option>
                    <option value="3 - Restrike Recommended">3 - Restrike Recommended</option>
                </select>

                <!-- Submit Section -->
                <div class="timestamp">
                    <button type="submit" class="btn-primary">Submit Debrief</button>
                </div>
            </form>
        </div>

        <!-- Footer -->
        <div class="header" style="border-bottom: none; border-top: 1px solid var(--border-secondary); height: 108px; align-content: center">
            <img src="/static/img/logo2.png" width="80" height="72" alt="CVW-17 Logo" class="header-logo">
            <div class="footer-text">
                <div class="title" style="font-size: var(--font-size-xl);">VIRTUAL CARRIER AIR WING 17</div>
                <div class="subtitle">Not associated with the Department of Defence or any of its components.</div>
            </div>
        </div>
    </div>

    <script>
        // ===== Global State Management =====
        const AppState = {
            pilotCounter: 1,
            weaponCounters: { 1: 0 },
            uploadedImages: {},
            aaRowCounter: 0,
            selectedCallsign: null,
            jsonData: null
        };

        // ===== Constants =====
        const MAX_PILOTS = 4;
        const MODEX_MIN = 100;
        const MODEX_MAX = 999;
        const MISSION_NUMBER_MIN = 1000;
        const MISSION_NUMBER_MAX = 9999;

        // ===== Utility Functions =====
        function createElement(tag, className, innerHTML = '') {
            const element = document.createElement(tag);
            if (className) element.className = className;
            if (innerHTML) element.innerHTML = innerHTML;
            return element;
        }

        function removeElement(selector) {
            const element = document.querySelector(selector);
            if (element) element.remove();
        }

        // ===== A/A Weapons Functions =====
        function addAARow() {
            AppState.aaRowCounter++;
            const tbody = document.getElementById('aa-table-body');

            const newRow = createElement('tr');
            newRow.setAttribute('data-aa-row-id', AppState.aaRowCounter);
            newRow.innerHTML = `
                <td><input type="text" pattern="\\d{3}" required class="field-value-aircrew" style="border: none; background: transparent; text-align: center;" name="aa_weapons[${AppState.aaRowCounter}][modex]"></td>
                <td><input type="text" required list="aa-weapons" class="field-value-aircrew" style="border: none; background: transparent; text-align: center;" name="aa_weapons[${AppState.aaRowCounter}][weapon]"></td>
                <td><input type="text" required class="field-value-aircrew" style="border: none; background: transparent; text-align: center;" name="aa_weapons[${AppState.aaRowCounter}][target]"></td>
                <td><input type="number" min="0" max="99" class="field-value-aircrew" style="border: none; background: transparent; text-align: center;" name="aa_weapons[${AppState.aaRowCounter}][range]"></td>
                <td><input type="number" min="0.1" max="3" step="0.01" class="field-value-aircrew" style="border: none; background: transparent; text-align: center;" name="aa_weapons[${AppState.aaRowCounter}][speed]"></td>
                <td><input type="number" min="0" max="50" class="field-value-aircrew" style="border: none; background: transparent; text-align: center;" name="aa_weapons[${AppState.aaRowCounter}][own_altitude]"></td>
                <td><input type="number" min="0" max="50" class="field-value-aircrew" style="border: none; background: transparent; text-align: center;" name="aa_weapons[${AppState.aaRowCounter}][target_altitude]"></td>
                <td style="text-align: center;"><input type="checkbox" style="transform: scale(1.2);" name="aa_weapons[${AppState.aaRowCounter}][hit]" value="1"></td>
                <td style="border: none; background: transparent; padding-left: 10px; width: 30px; text-align: center;">
                    <button type="button" class="aa-remove-btn" onclick="removeAARow(${AppState.aaRowCounter})">✕</button>
                </td>
            `;

            tbody.appendChild(newRow);
        }

        function removeAARow(rowId) {
            removeElement(`[data-aa-row-id="${rowId}"]`);
        }

        // ===== A/G Weapons Functions =====
        function addWeaponCard(pilotId) {
            if (!AppState.weaponCounters[pilotId]) {
                AppState.weaponCounters[pilotId] = 0;
            }
            AppState.weaponCounters[pilotId]++;

            const weaponId = AppState.weaponCounters[pilotId];
            const agVertical = document.getElementById(`ag-vertical-${pilotId}`);
            const addButton = agVertical.querySelector('.btn-add');

            const newWeaponCard = createElement('div', 'weapon-card');
            newWeaponCard.setAttribute('data-weapon-id', weaponId);
            newWeaponCard.setAttribute('data-pilot-id', pilotId);
            newWeaponCard.innerHTML = `
                <button type="button" class="btn-remove" onclick="removeWeaponCard(${pilotId}, ${weaponId})">✕</button>
                <div class="weapon-name">
                    <input type="text" required minlength="3" maxlength="32"
                           class="field-value-aircrew" style="text-align: left; padding: 0px 8px;"
                           placeholder="Weapon Name*"
                           name="ag_weapons[${pilotId}][${weaponId}][weapon_name]">
                </div>
                <div class="target-dmpi-table">
                    <select class="field-value" style="color-scheme: dark"
                            name="ag_weapons[${pilotId}][${weaponId}][target_type]"
                            onchange="updateTargetInput(${pilotId}, ${weaponId})">
                        <option value="none" selected>NONE</option>
                        <option value="dmpi">DMPI ID</option>
                        <option value="target">TARGET</option>
                    </select>
                    <div class="weapon-name">
                        <input type="text" minlength="3" maxlength="64"
                               class="field-value-aircrew" style="text-align: left; padding: 0px 8px;"
                               name="ag_weapons[${pilotId}][${weaponId}][target_value]"
                               id="target-input-${pilotId}-${weaponId}"
                               placeholder="" disabled>
                    </div>
                </div>
                <input type="hidden" name="ag_weapons[${pilotId}][${weaponId}][image_data]" id="image-data-${pilotId}-${weaponId}">
                <input type="hidden" name="ag_weapons[${pilotId}][${weaponId}][bda_result]" id="bda-result-hidden-${pilotId}-${weaponId}">
            `;

            agVertical.insertBefore(newWeaponCard, addButton);
        }

        function removeWeaponCard(pilotId, weaponId) {
            const weaponCard = document.querySelector(`[data-weapon-id="${weaponId}"][data-pilot-id="${pilotId}"]`);
            if (weaponCard) {
                weaponCard.remove();

                const uploadId = `upload-${pilotId}-${weaponId}`;
                delete AppState.uploadedImages[uploadId];

                updateBDACards();
            }
        }

        function updateTargetInput(pilotId, weaponId) {
            const select = document.querySelector(`select[name="ag_weapons[${pilotId}][${weaponId}][target_type]"]`);
            const input = document.getElementById(`target-input-${pilotId}-${weaponId}`);

            switch(select.value) {
                case 'none':
                    input.placeholder = '';
                    input.disabled = true;
                    input.value = '';
                    break;
                case 'dmpi':
                    input.placeholder = 'DMPI ID';
                    input.disabled = false;
                    break;
                case 'target':
                    input.placeholder = 'TARGET';
                    input.disabled = false;
                    break;
            }

            updateBDACards();
        }

        // ===== Pilot Card Functions =====
        function addPilotCard() {
            AppState.pilotCounter++;
            const pilotGrid = document.getElementById('aircrew');

            if (AppState.pilotCounter >= MAX_PILOTS) {
                AppState.pilotCounter = MAX_PILOTS;
                pilotGrid.querySelectorAll('.btn-add').forEach(btn => btn.remove());
            }

            pilotGrid.querySelectorAll('.btn-remove').forEach(btn => btn.remove());

            const newCard = createElement('div', 'pilot-card');
            newCard.setAttribute('data-pilot-id', AppState.pilotCounter);
            newCard.innerHTML = `
                <button type="button" class="btn-remove" onclick="removePilotCard(${AppState.pilotCounter})">✕</button>
                ${AppState.jsonData ? `<button type="button" class="btn-load-modex" onclick="loadDataByModex(${AppState.pilotCounter})" title="Load weapons from server">↓</button>` : ''}
                <div class="callsign-name">${AppState.selectedCallsign || 'CALLSIGN'}${AppState.pilotCounter}</div>
                <div class="pilot-details">
                    <div>
                        <div class="field-label" style="text-align: center; padding-left: 0px;">MODEX*</div>
                        <input type="text" required pattern="\\d{3}"
                               class="field-value-aircrew"
                               name="aircrew[${AppState.pilotCounter}][modex]"
                               id="aircrew_${AppState.pilotCounter}_modex">
                    </div>
                    <div>
                        <div class="field-label" style="text-align: center; padding-left: 0px;">AIRCREW</div>
                        <div style="display: flex;">
                            <input type="text" required minlength="2" maxlength="32"
                                   class="field-value-aircrew"
                                   name="aircrew[${AppState.pilotCounter}][pilot]"
                                   placeholder="Pilot*"
                                   id="aircrew_${AppState.pilotCounter}_pilot">
                            <input type="text" minlength="2" maxlength="32"
                                   class="field-value-aircrew"
                                   name="aircrew[${AppState.pilotCounter}][rio]"
                                   placeholder="Rio"
                                   id="aircrew_${AppState.pilotCounter}_rio">
                        </div>
                    </div>
                </div>
            `;

            AppState.weaponCounters[AppState.pilotCounter] = 0;

            const newAGCard = createElement('div', 'ag-grid-vertical-box');
            newAGCard.setAttribute('data-ag-pilot-id', AppState.pilotCounter);
            newAGCard.innerHTML = `
                <div class="ag-grid-vertical" id="ag-vertical-${AppState.pilotCounter}">
                    <div class="ag-grid-header">${AppState.selectedCallsign || 'CALLSIGN'}${AppState.pilotCounter}</div>
                    <button type="button" class="btn-add" onclick="addWeaponCard(${AppState.pilotCounter})" style="height: 120px;">
                        <span class="add-icon">+</span>
                    </button>
                </div>
            `;

            const lastButton = pilotGrid.querySelector('.btn-add:last-child');
            pilotGrid.insertBefore(newCard, lastButton);

            document.getElementById('ag-grid').insertBefore(newAGCard, document.getElementById('ag-grid').lastChild);
        }

        function removePilotCard(pilotId) {
            const modexInput = document.getElementById(`aircrew_${pilotId}_modex`);
            const modexValue = modexInput ? modexInput.value : null;

            removeElement(`[data-pilot-id="${pilotId}"]`);
            removeElement(`[data-ag-pilot-id="${pilotId}"]`);

            if (modexValue) {
                const aaRows = document.querySelectorAll('#aa-table-body tr');
                aaRows.forEach(row => {
                    const modexCell = row.querySelector('input[name*="[modex]"]');
                    if (modexCell && modexCell.value === modexValue) {
                        row.remove();
                    }
                });
            }

            delete AppState.weaponCounters[pilotId];
            AppState.pilotCounter--;

            const remainingPilots = document.querySelectorAll('.pilot-card');

            if (remainingPilots.length > 1) {
                let highestId = 1;
                let mostRecentPilot = null;

                remainingPilots.forEach(pilot => {
                    const id = parseInt(pilot.getAttribute('data-pilot-id'));
                    if (id > highestId) {
                        highestId = id;
                        mostRecentPilot = pilot;
                    }
                });

                if (mostRecentPilot && highestId > 1) {
                    const removeBtn = createElement('button', 'btn-remove');
                    removeBtn.type = 'button';
                    removeBtn.onclick = () => removePilotCard(highestId);
                    removeBtn.innerHTML = '✕';
                    mostRecentPilot.appendChild(removeBtn);
                }
            }

            if (remainingPilots.length < MAX_PILOTS) {
                const pilotGrid = document.getElementById('aircrew');
                const existingAddButtons = pilotGrid.querySelectorAll('.btn-add');

                if (existingAddButtons.length === 0) {
                    const addButton1 = createElement('button', 'btn-add');
                    addButton1.type = 'button';
                    addButton1.onclick = addPilotCard;
                    addButton1.innerHTML = '<span class="add-icon">+</span>';

                    const addButton2 = createElement('button', 'btn-add');
                    addButton2.type = 'button';
                    addButton2.onclick = addPilotCard;
                    addButton2.innerHTML = '<span class="add-icon">+</span>';

                    pilotGrid.insertBefore(addButton1, pilotGrid.firstChild);
                    pilotGrid.appendChild(addButton2);
                }
            }

            // Clean up uploaded images
            Object.keys(AppState.uploadedImages).forEach(uploadId => {
                if (uploadId.includes(`-${pilotId}-`)) {
                    delete AppState.uploadedImages[uploadId];
                }
            });

            updateBDACards();
        }

        // ===== BDA Functions =====
        function updateBDACards() {
            const bdaGrid = document.getElementById('bda-grid');

            // Store current BDA results
            const currentBDAResults = {};
            const existingSelects = bdaGrid.querySelectorAll('select[name*="bda_result"]');
            existingSelects.forEach(select => {
                const match = select.name.match(/ag_weapons\[(\d+)\]\[(\d+)\]\[bda_result\]/);
                if (match) {
                    const pilotId = match[1];
                    const weaponId = match[2];
                    currentBDAResults[`${pilotId}-${weaponId}`] = select.value;
                }
            });

            bdaGrid.innerHTML = '';

            const weaponCards = document.querySelectorAll('.weapon-card');

            weaponCards.forEach(weaponCard => {
                const pilotId = weaponCard.getAttribute('data-pilot-id');
                const weaponId = weaponCard.getAttribute('data-weapon-id');

                const weaponNameInput = weaponCard.querySelector(`input[name="ag_weapons[${pilotId}][${weaponId}][weapon_name]"]`);
                const targetSelect = weaponCard.querySelector(`select[name="ag_weapons[${pilotId}][${weaponId}][target_type]"]`);
                const targetInput = document.getElementById(`target-input-${pilotId}-${weaponId}`);

                if (targetSelect && targetSelect.value !== 'none' && targetInput && targetInput.value.trim() !== '') {
                    const callsign = document.querySelector(`[data-pilot-id="${pilotId}"] .callsign-name`).textContent;
                    const weaponName = weaponNameInput ? weaponNameInput.value : '';
                    const targetType = targetSelect.value === 'dmpi' ? 'DMPI ID' : 'TARGET';
                    const targetValue = targetInput.value;
                    const uploadId = `upload-${pilotId}-${weaponId}`;
                    const bdaKey = `${pilotId}-${weaponId}`;
                    const savedBDAResult = currentBDAResults[bdaKey] || '';

                    const bdaCard = createBDACard({
                        callsign,
                        targetType,
                        targetValue,
                        weaponName,
                        uploadId,
                        pilotId,
                        weaponId,
                        savedBDAResult
                    });

                    bdaGrid.appendChild(bdaCard);

                    // Update hidden input
                    const hiddenInput = document.getElementById(`bda-result-hidden-${pilotId}-${weaponId}`);
                    if (hiddenInput && savedBDAResult) {
                        hiddenInput.value = savedBDAResult;
                    }

                    // Restore uploaded image if exists
                    if (AppState.uploadedImages[uploadId]) {
                        setTimeout(() => {
                            const uploadArea = document.getElementById(uploadId);
                            if (uploadArea) {
                                displayUploadedImage(uploadArea, uploadId, pilotId, weaponId, AppState.uploadedImages[uploadId]);
                            }
                        }, 0);
                    }
                }
            });
        }

        function createBDACard(params) {
            const bdaCard = createElement('div', 'bda-card');
            bdaCard.innerHTML = `
                <div class="aircraft-callsign">${params.callsign}</div>
                <div class="target-name">${params.targetType}: ${params.targetValue}</div>
                <div class="weapon-name">${params.weaponName}</div>
                <div class="file-upload-area" id="${params.uploadId}"
                    ondrop="handleDrop(event, '${params.uploadId}', ${params.pilotId}, ${params.weaponId})"
                    ondragover="handleDragOver(event)"
                    ondragleave="handleDragLeave(event)">
                    <div class="file-upload-controls">
                        <div>Drop image here</div>
                        <button type="button" class="file-upload-button"
                                onclick="event.stopPropagation(); document.getElementById('file-input-${params.uploadId}').click()">
                            Browse Files
                        </button>
                        <button type="button" class="file-upload-button"
                                onclick="event.stopPropagation(); pasteFromClipboard('${params.uploadId}', ${params.pilotId}, ${params.weaponId})">
                            Paste from Clipboard
                        </button>
                    </div>
                    <input type="file" id="file-input-${params.uploadId}" class="hidden-file-input"
                        accept="image/*" onchange="handleFileSelect(event, '${params.uploadId}', ${params.pilotId}, ${params.weaponId})">
                </div>
                <select class="field-value" style="width: 100%; margin-top: 10px; background: var(--bg-section);"
                        name="ag_weapons[${params.pilotId}][${params.weaponId}][bda_result]"
                        id="bda-result-${params.pilotId}-${params.weaponId}">
                    <option value="">Select BDA Result...</option>
                    <option value="1 - Direct Hit Visual" ${params.savedBDAResult === '1 - Direct Hit Visual' ? 'selected' : ''}>1 - Direct Hit Visual</option>
                    <option value="2 - Direct Hit Sensor" ${params.savedBDAResult === '2 - Direct Hit Sensor' ? 'selected' : ''}>2 - Direct Hit Sensor</option>
                    <option value="3 - Damaged Visual" ${params.savedBDAResult === '3 - Damaged Visual' ? 'selected' : ''}>3 - Damaged Visual</option>
                    <option value="4 - Damaged Sensor" ${params.savedBDAResult === '4 - Damaged Sensor' ? 'selected' : ''}>4 - Damaged Sensor</option>
                    <option value="5 - Near Miss/Unknown Damage" ${params.savedBDAResult === '5 - Near Miss/Unknown Damage' ? 'selected' : ''}>5 - Near Miss/Unknown Damage</option>
                    <option value="6 - Missed Target" ${params.savedBDAResult === '6 - Missed Target' ? 'selected' : ''}>6 - Missed Target</option>
                    <option value="7 - No Drop/Abort" ${params.savedBDAResult === '7 - No Drop/Abort' ? 'selected' : ''}>7 - No Drop/Abort</option>
                </select>
            `;
            return bdaCard;
        }

        // ===== Image Upload Functions =====
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e, uploadId, pilotId, weaponId) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                displayImage(files[0], uploadId, pilotId, weaponId);
            }
        }

        function handleFileSelect(e, uploadId, pilotId, weaponId) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                displayImage(file, uploadId, pilotId, weaponId);
            }
        }

        function displayImage(file, uploadId, pilotId, weaponId) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;

                AppState.uploadedImages[uploadId] = imageData;

                // Store image data in hidden input
                const hiddenInput = document.getElementById(`image-data-${pilotId}-${weaponId}`);
                if (hiddenInput) {
                    hiddenInput.value = imageData;
                }

                const uploadArea = document.getElementById(uploadId);
                if (uploadArea) {
                    displayUploadedImage(uploadArea, uploadId, pilotId, weaponId, imageData);
                }
            };
            reader.readAsDataURL(file);
        }

        function displayUploadedImage(uploadArea, uploadId, pilotId, weaponId, imageData) {
            uploadArea.innerHTML = `
                <img src="${imageData}" alt="Target Image">
                <div class="image-overlay-controls">
                    <button type="button" class="overlay-button"
                            onclick="event.stopPropagation(); document.getElementById('file-input-${uploadId}').click()">
                        Change
                    </button>
                    <button type="button" class="overlay-button danger"
                            onclick="event.stopPropagation(); removeImage('${uploadId}', ${pilotId}, ${weaponId})">
                        Remove
                    </button>
                </div>
                <input type="file" id="file-input-${uploadId}" class="hidden-file-input"
                    accept="image/*" onchange="handleFileSelect(event, '${uploadId}', ${pilotId}, ${weaponId})">
            `;
        }

        function removeImage(uploadId, pilotId, weaponId) {
            delete AppState.uploadedImages[uploadId];

            // Clear hidden input
            const hiddenInput = document.getElementById(`image-data-${pilotId}-${weaponId}`);
            if (hiddenInput) {
                hiddenInput.value = '';
            }

            const uploadArea = document.getElementById(uploadId);
            if (uploadArea) {
                uploadArea.innerHTML = `
                    <div class="file-upload-controls">
                        <div>Drop image here</div>
                        <button type="button" class="file-upload-button"
                                onclick="event.stopPropagation(); document.getElementById('file-input-${uploadId}').click()">
                            Browse Files
                        </button>
                        <button type="button" class="file-upload-button"
                                onclick="event.stopPropagation(); pasteFromClipboard('${uploadId}', ${pilotId}, ${weaponId})">
                            Paste from Clipboard
                        </button>
                    </div>
                    <input type="file" id="file-input-${uploadId}" class="hidden-file-input"
                        accept="image/*" onchange="handleFileSelect(event, '${uploadId}', ${pilotId}, ${weaponId})">
                `;
            }
        }

        async function pasteFromClipboard(uploadId, pilotId, weaponId) {
            try {
                const clipboardItems = await navigator.clipboard.read();
                for (const clipboardItem of clipboardItems) {
                    for (const type of clipboardItem.types) {
                        if (type.startsWith('image/')) {
                            const blob = await clipboardItem.getType(type);
                            displayImage(blob, uploadId, pilotId, weaponId);
                            return;
                        }
                    }
                }
                alert('No image found in clipboard');
            } catch (err) {
                console.error('Failed to read clipboard contents: ', err);
                alert('Failed to access clipboard. Please use drag & drop or file selection.');
            }
        }

        // ===== Callsign Functions =====
        function updateAllCallsigns(callsign) {
            // Update pilot card callsigns
            document.querySelectorAll('.callsign-name').forEach((element, index) => {
                element.textContent = `${callsign}${index + 1}`;
            });

            // Update AG grid headers
            document.querySelectorAll('.ag-grid-header').forEach((element, index) => {
                element.textContent = `${callsign}${index + 1}`;
            });

            AppState.selectedCallsign = callsign;
            document.getElementById('callsign').value = callsign;
        }

        // ===== Form Data Management =====
        function setNestedValue(obj, path, value) {
            // Handle array notation like aircrew[1][modex]
            const arrayMatch = path.match(/^(\w+)\[(\d+)\]\[(\w+)\]$/);
            if (arrayMatch) {
                const [, arrayName, index, fieldName] = arrayMatch;

                if (!obj[arrayName]) obj[arrayName] = {};
                if (!obj[arrayName][index]) obj[arrayName][index] = {};

                obj[arrayName][index][fieldName] = value;
                return;
            }

            // Handle nested array notation like ag_weapons[1][2][weapon_name]
            const nestedArrayMatch = path.match(/^(\w+)\[(\d+)\]\[(\d+)\]\[(\w+)\]$/);
            if (nestedArrayMatch) {
                const [, arrayName, pilotId, weaponId, fieldName] = nestedArrayMatch;

                if (!obj[arrayName]) obj[arrayName] = {};
                if (!obj[arrayName][pilotId]) obj[arrayName][pilotId] = {};
                if (!obj[arrayName][pilotId][weaponId]) obj[arrayName][pilotId][weaponId] = {};

                obj[arrayName][pilotId][weaponId][fieldName] = value;
                return;
            }

            // Handle simple field names
            obj[path] = value;
        }

        function getFormDataAsJSON() {
            const formData = new FormData(document.getElementById('apStrikeForm'));
            const data = {};

            for (let [name, value] of formData.entries()) {
                setNestedValue(data, name, value);
            }

            return data;
        }

        function getCompleteFormData() {
            const baseData = getFormDataAsJSON();

            // Convert aircrew object to array
            if (baseData.aircrew) {
                baseData.aircrew = Object.values(baseData.aircrew).map(pilot => ({
                    modex: pilot.modex || '',
                    pilot: pilot.pilot || '',
                    rio: pilot.rio || ''
                }));
            }

            // Convert AA weapons object to array
            if (baseData.aa_weapons) {
                baseData.aa_weapons = Object.values(baseData.aa_weapons).map(weapon => ({
                    modex: weapon.modex || '',
                    weapon: weapon.weapon || '',
                    target: weapon.target || '',
                    range: weapon.range ? parseFloat(weapon.range) : null,
                    speed: weapon.speed ? parseFloat(weapon.speed) : null,
                    own_altitude: weapon.own_altitude ? parseFloat(weapon.own_altitude) : null,
                    target_altitude: weapon.target_altitude ? parseFloat(weapon.target_altitude) : null,
                    hit: weapon.hit === '1'
                }));
            }

            // Convert AG weapons object to array
            if (baseData.ag_weapons) {
                const agWeaponsArray = [];
                Object.keys(baseData.ag_weapons).forEach(pilotId => {
                    Object.keys(baseData.ag_weapons[pilotId]).forEach(weaponId => {
                        const weapon = baseData.ag_weapons[pilotId][weaponId];
                        if (weapon.weapon_name || weapon.target_value) {
                            agWeaponsArray.push({
                                pilot_id: parseInt(pilotId),
                                weapon_id: parseInt(weaponId),
                                weapon_name: weapon.weapon_name || '',
                                target_type: weapon.target_type || 'none',
                                target_value: weapon.target_value || '',
                                image_data: weapon.image_data || '',
                                bda_result: weapon.bda_result || ''
                            });
                        }
                    });
                });
                baseData.ag_weapons = agWeaponsArray;
            }

            // Add metadata
            baseData.form_metadata = {
                submission_time: new Date().toISOString(),
                total_aircrew: baseData.aircrew ? baseData.aircrew.length : 0,
                total_ag_weapons: baseData.ag_weapons ? baseData.ag_weapons.length : 0,
                total_aa_weapons: baseData.aa_weapons ? baseData.aa_weapons.length : 0,
                total_bdas: baseData.ag_weapons ? baseData.ag_weapons.filter(w => w.image_data && w.image_data.trim() !== '').length : 0,
                has_images: baseData.ag_weapons ? baseData.ag_weapons.some(w => w.image_data) : false
            };

            // Initialize empty arrays if not present
            if (!baseData.aircrew) baseData.aircrew = [];
            if (!baseData.aa_weapons) baseData.aa_weapons = [];
            if (!baseData.ag_weapons) baseData.ag_weapons = [];

            return baseData;
        }

        // ===== Form Submission Functions =====
        async function submitToBackend(formData) {
            const submitButton = document.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;

            try {
                submitButton.textContent = 'Submitting...';
                submitButton.disabled = true;

                const response = await fetch('/submit-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.id) {
                        submitButton.textContent = 'Success! Redirecting...';

                        setTimeout(() => {
                            window.location.href = `/debrief/${result.id}`;
                        }, 1000);
                    } else {
                        console.log('Server response:', result);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Submission error:', error);
                alert(`❌ Failed to submit strike report:\n${error.message}`);

                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        }

        // ===== JSON Data Loading Functions =====
        function callsignToDL(callsign) {
            const match = callsign.match(/^([A-Z]+)(\d+)$/);
            if (!match) return null;

            const [, base, number] = match;
            const firstLetter = base.charAt(0);
            const lastLetter = base.charAt(base.length - 1);

            return `${firstLetter}${lastLetter}${number}`;
        }

        function filterDataByCallsign(jsonData, currentCallsign) {
            if (!currentCallsign || !jsonData) return [];

            const currentDL = callsignToDL(currentCallsign);
            if (!currentDL) return [];

            return jsonData.filter(entry => {
                if (!entry.DL_CALLSIGN) return false;
                const entryBase = entry.DL_CALLSIGN.replace(/\d$/, '');
                return entryBase === currentDL;
            });
        }

        function loadDataFromJSON(jsonData) {
            if (!jsonData || jsonData.length === 0) {
                return;
            }

            const currentCallsign = AppState.selectedCallsign;
            if (!currentCallsign) {
                alert('Please select a callsign first');
                return;
            }

            const filteredData = filterDataByCallsign(jsonData, currentCallsign);

            if (filteredData.length === 0) {
                alert(`No data found for ${currentCallsign}1`);
                return;
            }

            // Group data by aircraft
            const aircraftGroups = {};
            filteredData.forEach(entry => {
                if (!aircraftGroups[entry.DL_CALLSIGN]) {
                    aircraftGroups[entry.DL_CALLSIGN] = [];
                }
                aircraftGroups[entry.DL_CALLSIGN].push(entry);
            });

            // Clear existing data
            const existingCards = document.querySelectorAll('.pilot-card[data-pilot-id]');
            existingCards.forEach((card, index) => {
                if (index > 0) {
                    const pilotId = card.getAttribute('data-pilot-id');
                    removePilotCard(parseInt(pilotId));
                }
            });

            document.getElementById('aa-table-body').innerHTML = '';
            AppState.aaRowCounter = 0;

            let pilotIndex = 1;

            // Process each aircraft
            Object.keys(aircraftGroups).forEach(dlCallsign => {
                const aircraftData = aircraftGroups[dlCallsign];
                const firstEntry = aircraftData[0];

                // Ensure we have enough pilot cards
                while (pilotIndex > document.querySelectorAll('.pilot-card').length) {
                    addPilotCard();
                }

                // Fill aircrew data
                const modexInput = document.getElementById(`aircrew_${pilotIndex}_modex`);
                const pilotInput = document.getElementById(`aircrew_${pilotIndex}_pilot`);
                const rioInput = document.getElementById(`aircrew_${pilotIndex}_rio`);

                if (modexInput) modexInput.value = firstEntry.TAIL_NUMBER ?? '';
                if (pilotInput) pilotInput.value = firstEntry.PILOT_NAME ?? '';
                if (rioInput) rioInput.value = firstEntry.RIO_NAME ?? '';

                // Process weapons
                aircraftData.forEach(entry => {
                    if (entry.TYPE === 0) {
                        // A/G Weapon
                        addWeaponCard(pilotIndex);
                        const weaponId = AppState.weaponCounters[pilotIndex];

                        const weaponNameInput = document.querySelector(`input[name="ag_weapons[${pilotIndex}][${weaponId}][weapon_name]"]`);
                        const targetSelect = document.querySelector(`select[name="ag_weapons[${pilotIndex}][${weaponId}][target_type]"]`);
                        const targetInput = document.getElementById(`target-input-${pilotIndex}-${weaponId}`);

                        if (weaponNameInput) weaponNameInput.value = entry.WEAPON_NAME ?? '';
                        if (entry.TGT_NAME === "NONE")
                            entry.TGT_NAME = ''
                        if (entry.TGT_TNAME === "NONE")
                            entry.TGT_TNAME = ''

                        if (targetSelect && (entry.TGT_NAME || entry.TGT_TNAME)) {
                            targetSelect.value = 'target';
                            targetSelect.dispatchEvent(new Event('change'));
                        }
                        if (targetInput) targetInput.value = entry.TGT_NAME ?? entry.TGT_TNAME ?? '';

                    } else if (entry.TYPE === 1) {
                        // A/A Weapon
                        addAARow();

                        const modexInput = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][modex]"]`);
                        const weaponInput = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][weapon]"]`);
                        const targetInput = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][target]"]`);
                        const rangeInput = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][range]"]`);
                        const speedInput = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][speed]"]`);
                        const ownAltInput = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][own_altitude]"]`);
                        const targetAltInput = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][target_altitude]"]`);
                        const hitCheckbox = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][hit]"]`);

                        if (modexInput) modexInput.value = entry.TAIL_NUMBER ?? '';
                        if (weaponInput) weaponInput.value = entry.WEAPON_NAME ?? '';
                        if (targetInput) targetInput.value = entry.TGT_TNAME ?? entry.TGT_NAME ?? '';
                        if (rangeInput) rangeInput.value = entry.RANGE ?? '';
                        if (speedInput) speedInput.value = entry.SPEED ?? '';
                        if (ownAltInput) ownAltInput.value = entry.ANGELS ?? '';
                        if (targetAltInput) targetAltInput.value = entry.ANGELS_TGT ?? '';
                        if (hitCheckbox) hitCheckbox.checked = (entry.HIT === true || entry.DESTROYED === true);
                    }
                });

                pilotIndex++;
            });

            for (let i = 1; i < pilotIndex; i++) {
                const pilotCard = document.querySelector(`[data-pilot-id="${i}"]`);
                if (pilotCard) {
                    // Check if this pilot card has any data
                    const modexInput = document.getElementById(`aircrew_${i}_modex`);
                    const pilotInput = document.getElementById(`aircrew_${i}_pilot`);

                    // Only mark as loaded if it has modex or pilot name
                    if ((modexInput && modexInput.value) || (pilotInput && pilotInput.value)) {
                        pilotCard.setAttribute('data-loaded-from-json', 'true');
                    }
                }
            }

            setTimeout(() => {
                updateBDACards();
            }, 100);
        }

        function handleJSONFileUpload() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';

            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            loadDataFromJSON(jsonData);
                        } catch (error) {
                            alert('Error parsing JSON file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };

            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }

        // ===== Event Listeners =====
        function initializeEventListeners() {
            // Form submission
            document.getElementById('apStrikeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = getCompleteFormData();
                submitToBackend(formData);
            });

            // Update BDA cards on input changes
            document.addEventListener('input', function(e) {
                if (e.target.name && (e.target.name.includes('weapon_name') || e.target.name.includes('target_value'))) {
                    updateBDACards();
                }
            });

            // Handle BDA result changes
            document.addEventListener('change', function(e) {
                if (e.target.name && e.target.name.includes('bda_result')) {
                    const match = e.target.name.match(/ag_weapons\[(\d+)\]\[(\d+)\]\[bda_result\]/);
                    if (match) {
                        const pilotId = match[1];
                        const weaponId = match[2];
                        const hiddenInput = document.getElementById(`bda-result-hidden-${pilotId}-${weaponId}`);
                        if (hiddenInput) {
                            hiddenInput.value = e.target.value;
                        }
                    }
                }
            });

            // File upload area clicks
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('file-upload-area') && !e.target.querySelector('img')) {
                    const uploadId = e.target.id;
                    if (uploadId) {
                        document.getElementById(`file-input-${uploadId}`).click();
                    }
                }
            });
        }

        // ===== Initialization =====
        window.onload = function() {
            // Set current date
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${yyyy}-${mm}-${dd}`;
            document.getElementById("mission_date").value = formattedDate;

            // Setup callsign selection
            const callsignSelect = document.getElementById('callsignSelect');
            const confirmButton = document.getElementById('confirmCallsign');
            const popup = document.getElementById('callsignPopup');

            const loadButton = document.getElementById('loadButton');
            const manualButton = document.getElementById('manualButton');
            const missionDataSelect = document.getElementById('missionDataSelect');

            fetchMissionDataLabels();

            function updateButtonStates() {
                const hasCallsign = !!callsignSelect.value;
                const hasMissionData = !!missionDataSelect.value;

                loadButton.disabled = !hasCallsign || !hasMissionData;
                manualButton.disabled = !hasCallsign;
            }

            callsignSelect.addEventListener('change', updateButtonStates);
            missionDataSelect.addEventListener('change', updateButtonStates);

            loadButton.addEventListener('click', async function() {
                const selectedCallsign = callsignSelect.value;
                const selectedMissionId = missionDataSelect.value;

                if (selectedCallsign && selectedMissionId) {
                    updateAllCallsigns(selectedCallsign);

                    // Fetch and load the mission data
                    const missionData = await fetchMissionData(selectedMissionId);
                    AppState.jsonData = missionData;

                    // Show load button on first card if JSON data is available
                    const firstCardLoadBtn = document.querySelector('[data-pilot-id="1"] .btn-load-modex');
                    if (firstCardLoadBtn && missionData) {
                        firstCardLoadBtn.style.display = '';
                    }

                    if (missionData) {
                        loadDataFromJSON(missionData);
                    }

                    popup.style.display = 'none';
                }
            });

// Manual button - only sets callsign
            manualButton.addEventListener('click', function() {
                const selectedCallsign = callsignSelect.value;
                AppState.jsonData = null;
                // Hide load button on first card when manual is selected
                const firstCardLoadBtn = document.querySelector('[data-pilot-id="1"] .btn-load-modex');
                if (firstCardLoadBtn) {
                    firstCardLoadBtn.style.display = 'none';
                }

                if (selectedCallsign) {
                    updateAllCallsigns(selectedCallsign);
                    popup.style.display = 'none';
                }
            });

            // Initialize event listeners
            initializeEventListeners();
        };

        async function fetchMissionDataLabels() {
            try {
                const response = await fetch('/data-labels');
                const labels = await response.json();

                const missionDataSelect = document.getElementById('missionDataSelect');

                Object.entries(labels).forEach(([id, filename]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = filename;
                    missionDataSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to fetch mission data labels:', error);
            }
        }

        function loadDataByModex(pilotId) {
            if (!AppState.jsonData) return;

            const card = document.querySelector(`[data-pilot-id="${pilotId}"]`);
            if (card && card.getAttribute('data-loaded-from-json') === 'true') {
                return;
            }

            const modexInput = document.getElementById(`aircrew_${pilotId}_modex`);
            const modexValue = modexInput ? modexInput.value : null;

            if (!modexValue) {
                alert('Please enter a modex first');
                return;
            }

            // Find all entries matching this modex
            const matchingEntries = AppState.jsonData.filter(entry =>
                entry.TAIL_NUMBER === modexValue
            );

            if (matchingEntries.length === 0) {
                alert(`No data found for modex ${modexValue}`);
                return;
            }

            // Load pilot data
            const firstEntry = matchingEntries[0];
            const pilotInput = document.getElementById(`aircrew_${pilotId}_pilot`);
            const rioInput = document.getElementById(`aircrew_${pilotId}_rio`);

            if (pilotInput && firstEntry.PILOT_NAME) pilotInput.value = firstEntry.PILOT_NAME;
            if (rioInput && firstEntry.RIO_NAME) rioInput.value = firstEntry.RIO_NAME;

            // Process weapons for this pilot
            matchingEntries.forEach(entry => {
                if (entry.TYPE === 0) {
                    // A/G Weapon
                    addWeaponCard(pilotId);
                    const weaponId = AppState.weaponCounters[pilotId];

                    const weaponNameInput = document.querySelector(`input[name="ag_weapons[${pilotId}][${weaponId}][weapon_name]"]`);
                    const targetSelect = document.querySelector(`select[name="ag_weapons[${pilotId}][${weaponId}][target_type]"]`);
                    const targetInput = document.getElementById(`target-input-${pilotId}-${weaponId}`);

                    if (weaponNameInput) weaponNameInput.value = entry.WEAPON_NAME ?? '';

                    // Clean up target data - set to empty string if "NONE"
                    if (entry.TGT_NAME === "NONE") entry.TGT_NAME = '';
                    if (entry.TGT_TNAME === "NONE") entry.TGT_TNAME = '';

                    // Only set target type to 'target' if there's actually target data
                    if (targetSelect && (entry.TGT_NAME || entry.TGT_TNAME)) {
                        targetSelect.value = 'target';
                        targetSelect.dispatchEvent(new Event('change'));
                        if (targetInput) targetInput.value = entry.TGT_NAME ?? entry.TGT_TNAME ?? '';
                    } else {
                        // Keep default 'none' selection if no target data
                        if (targetSelect) {
                            targetSelect.value = 'none';
                            targetSelect.dispatchEvent(new Event('change'));
                        }
                    }

                } else if (entry.TYPE === 1) {
                    // A/A Weapon
                    addAARow();

                    const modexInput = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][modex]"]`);
                    const weaponInput = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][weapon]"]`);
                    const targetInput = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][target]"]`);
                    const rangeInput = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][range]"]`);
                    const speedInput = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][speed]"]`);
                    const ownAltInput = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][own_altitude]"]`);
                    const targetAltInput = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][target_altitude]"]`);
                    const hitCheckbox = document.querySelector(`input[name="aa_weapons[${AppState.aaRowCounter}][hit]"]`);

                    if (modexInput) modexInput.value = entry.TAIL_NUMBER ?? '';
                    if (weaponInput) weaponInput.value = entry.WEAPON_NAME ?? '';
                    if (targetInput) targetInput.value = entry.TGT_TNAME ?? entry.TGT_NAME ?? '';
                    if (rangeInput) rangeInput.value = entry.RANGE ?? '';
                    if (speedInput) speedInput.value = entry.SPEED ?? '';
                    if (ownAltInput) ownAltInput.value = entry.ANGELS ?? '';
                    if (targetAltInput) targetAltInput.value = entry.ANGELS_TGT ?? '';
                    if (hitCheckbox) hitCheckbox.checked = entry.HIT === true;
                }
            });

            // Mark this pilot card as loaded
            const pilotCard = document.querySelector(`[data-pilot-id="${pilotId}"]`);
            if (pilotCard) {
                pilotCard.setAttribute('data-loaded-from-json', 'true');
                // Hide the load button after loading
                const loadBtn = pilotCard.querySelector('.btn-load-modex');
                if (loadBtn) loadBtn.style.display = 'none';
            }

            setTimeout(() => {
                updateBDACards();
            }, 100);
        }

        async function fetchMissionData(id) {
            try {
                const response = await fetch(`/data?id=${id}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Failed to fetch mission data:', error);
                return null;
            }
        }
    </script>
</body>
</html>
